---
title: A preliminary evaluation of the evidence supporting fishery-driven localised depletion effects on the performance and demographic trends of pygoscelid penguins in Subarea 48.1
author:
  - name: Andrew Lowther
    email: andrew.lowther@npolar.no
    footnote: 1
  - name: Martin Biuw
    email: martin.biuw@hi.no
    footnote: 2
    affiliation: Institute of Marine Research (Tromsø)
  - name: Ulf Lindstrøm
    email: ulf.lindstroem@hi.no
    affiliation: Institute of Marine Research (Tromsø)
    footnote: 2
  - name: Bjørn A. Krafft
    email: bjorn.krafft@hi.no
    affiliation: Institute of Marine Research (Bergen)
    footnote: 2
#address:
#  - code: Norwegian Polar Institute
#    address: Norwegian Polar Institute, Research Department, Fram Centre, Hjalmar Johansensgata 14, Tromsø, Norway,9297
#  - code: Institute of Marine Research (Tromsø)
#    address: Institute of Marine Research, Tromsø 9296, Norway
#  - code: Institute of Marine Research (Bergen)
#    address: Institute of Marine Research, Nordnesgaten 50, 5005 Bergen, Norway
footnote:
  - code: 1
    text: "Corresponding Author"
  - code: 2
    text: "Equal contribution"
abstract: |
    Two independent lines of evidence have been presented to the working groups and SC-CAMLR that claim to demonstrate that fishery-driven localised depletion of krill around pygoscelid penguin colonies has had a deleterious effect on their performance traits and demographic trends, that are equivalent to the impacts of climate variation. One study utilises 30 years of penguin foraging and reproductive performance of penguins in relation to krill biomass using 30 years of data collected at two colonies in the South Shetland Islands, whereas the other uses demographic rate changes derived from a comprehensive dataset of penguin population count data across Subarea 48.1 matched against acoustic measurements of krill biomass and krill catches at the gSSMU scale [@Watters2020].  The second uses estimated population trajectories across a wide range of penguin breeding colonies in relation to krill catches within a 30km radius [@Kruger2021]. Both studies then explore the synergistic relationships to measurements of broad-scale climactic variation (El Niño-Southern Oscillation; ENSO, and the Southern Annular Mode; SAM).  Herein we provide a preliminary assessment of the efficacy of both approaches in drawing conclusions, that are now being used at the Commission level, as representing sound scientific advice. We demonstrate that several underlying assumptions in Watters et al. 2020 are contrary to the published scientific literature, and when the model syntax is re-written to reflect these, predicted penguin performance against long term expected means are substantially different to those presented to CCAMLR.  The evidence provided by @Kruger2021 uses a different analytical approach, however given the details provided we were unable to recreate the initial results and could not test the sensitivity of the model to some of the assumptions made. We do, however, point to areas in which we have concerns, and would welcome collaboration in order to clarify and address these through a more in-depth future analysis.  Overall while our preliminary assessment focuses on potential issues, future work  will centre on considering competitive interactions both at appropriate time and space scales between the fishery as well as between a range of krill dependent predators beyond just pygoscelid penguins.
journal: "WG-EMM 2021"
geometry: margin=3cm
date: "`r Sys.Date()`"
bibliography: mylib.bib
#linenumbers: true
#numbersections: true
csl: elsevier-harvard.csl
output: 
  rticles::elsevier_article:
    fig_caption: FALSE
header-includes:
  - \usepackage{booktabs}
  - \usepackage{longtable}
  - \usepackage{array}
  - \usepackage{multirow}
  - \usepackage{wrapfig}
  - \usepackage{float}
  - \floatplacement{figure}{H}
  - \newcommand{\pandocbounded}[1]{#1}
  - \usepackage{colortbl}
  - \usepackage{pdflscape}
  - \usepackage{tabu}
  - \usepackage{threeparttable}
  - \usepackage{threeparttablex}
  - \usepackage[normalem]{ulem}
  - \usepackage{makecell}
  - \usepackage{xcolor}
  - \usepackage{booktabs}
  - \newcommand{\blandscape}{\begin{landscape}}
  - \newcommand{\elandscape}{\end{landscape}}
  - \usepackage{float} \floatplacement{figure}{H} 
  - \newcommand{\beginsupplement}{\setcounter{table}{0}  \renewcommand{\thetable}{S\arabic{table}}     -   - \setcounter{figure}{0} \renewcommand{\thefigure}{S\arabic{figure}}}
#output: html_document
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, comment=NA)
#options(knitr.kable.NA = '\\-')
library(trip)
library(raster)
#library(rgdal)
library(lubridate)
library(tidyverse)
library(sf)
library(raster)
#options(kableExtra.latex.load_packages = FALSE)
library(kableExtra)
library(RefManageR)
library(bibtex)
#library(rbbt)
library(pander)
library(track2KBA)
library(knitr)
library(lmerTest)
library(tabulapdf)
library(formatR)
```

```{r read in content, include=FALSE}
#table original
d.org = read_csv("hr_derived_s_original.csv",col_types="dddfd")
#table 37a
d37a = read_csv("hr_derived_s_37.csv",col_types="dddfd")
#table 37b
d37b = read_csv("hr_derived_s_37b.csv",col_types="dddfd")
#table 38
d38 = read_csv("hr_derived_s_38.csv",col_types="dddfd")
#table 39
#d39 = read_csv("hr_derived_s_39.csv",col_types="dddfd")
#table 40
#d40 = read_csv("hr_derived_s_40.csv",col_types="dddfd")
#table 41
#d41 = read_csv("hr_derived_s_41.csv",col_types="dddfd")
source('KrugerAnalyses.R')
messy = c("37a.R")

```

# Introduction

Concerns over the potential impact of localised depletion of krill
through concentrated fishing effort on krill-dependent predators has
been a topic of debate within SC-CAMLR and its Working Groups for many
years. Recently, two studies have been presented that suggest that local
harvesting rates can impact predator performance to the same degree as
poor environmental conditions [@Watters2020] and when poor climactic
conditions are coupled to locally high harvest rates the synergistic
impacts on predators are evident [@Kruger2021].

While both studies attempt to tackle the same overall problem, they do
so using very different methodologies. @Watters2020 analysed various
performance indices in relation to local krill biomass (LKB), local
harvesting rates (LHR) and the Oceanic Niño Index (ONI) using a
hierarchical bayesian model. The penguin performance indices (including
those collected under CEMP) were collected at two sites (Cape Shireff on
Livingstone Island and Copacabana on King George Island, South Shetland
Islands; Figure 1) in the period 1982 - 2016 whereas krill abundance
data, which cover the at-sea distributions of chinstrap, gentoo and
Adélie penguins, were collected during summer (1996 - 2011) and winter
(2012, 2014 and 2015). By drawing in monthly krill catches from the C1
Catch and Effort data and climate data (ONI), the authors use a
hierarchical analysis of variance approach to estimate the variance in
performance indices as a function of Local Krill Biomass (LKB), Local
Harvesting Rates (LHR; the ratio of krill catch to LKB) and ONI. In
contrast, @Kruger2021 utilise a broader range of penguin colonies across
chinstrap and gentoo penguins throughout the Antarctic Peninsula area,
in combination with their respective abundance survey estimates (number
of occupied nests) from an open-source database (www.penguinmap.org).
The authors calculate population trends for appropriate sites, and using
the CCAMLR C1 Catch and Effort data to extract annual catch values
within a 30km radius of each colony. Finally, @Kruger2021 use the sign
of the difference in the number of nests between annual surveys as a
response in a binomial generalised linear mixed effects model using the
accumulated annual catch and the mean wintertime Southern Annular Mode
(SAM) to determine the relative contributions of each predictor and
their interactive effects on population abundance trends. Both studies
draw similar conclusions; that local harvesting levels of krill impact
predators, and the degree of impact can either be similar to that of
poor environmental conditions or have a synergistic impact when high
local harvesting coincides with poor conditions.

The conclusions of these papers have been propagated into Commission
documentation supporting the reformulation of the D1MPA proposal
(CCAMLR-39/BG/02) as well as into Commission discussions (CCAMLR-39,
Para 5.48 & Para 5.51). However, while the two studies have moved from
Working Papers of EMM into the realm of the peer-reviewed literature,
there are some areas of concern regarding the structuring of these
studies that we think deserve attention. Some of these concerns are
unique to each study while others are common across both, and we
structure our paper accordingly. Firstly, we review @Watters2020 and
@Kruger2021 through the lens of some of the ecological assumptions made
versus the available evidence pertaining to them. Within the constraints
of the data and analytical methods that are available from the studies,
we also quantify how rationalising these assumptions to the evidence
available changes the model outputs and on the conclusions drawn. We
then highlight some overarching concerns applicable to both papers.

# @Watters2020 / WG-EMM 2019/11

A key goal for the paper is to highlight the consequences of mismatching
scales at which the Antarctic krill fishery is managed with the scales
at which ecological interactions between fishing extractions and
dependent predators occur. To do this, they create two strata aligned
with groups of SSMU (gSSMU); gSSMU #1 including those SSMU inside the
Bransfield Strait (APBSE and APBSW) and gSSMU #2 incorporating SSMU
north of the South Shetlands, including Elephant Island (APDPE, APDPW
and APEI) represented in Figure 1. These gSSMU cover $15,500nm^2$ and
$20,600nm^2$, respectively, and are used to characterise both krill
biomass and harvesting rates that are "local" to the penguin colonies
for which performance data are used. The reasoning behind scaling to
gSSMU are linked to the foraging behaviour of the penguins for which
performance data area available i.e. breeding, adult pygoscelids. The
authors cite @Hinke2017 as the evidence supporting usage of the two
gSSMU as appropriate strata.

Pygoscelid penguins exhibit staggered breeding, with Adélies commencing
first, followed by chinstraps then gentoos [@Black2016]. Adélie penguins
are the first to fledge their chicks and thus cease to be centrally
foraging, typically departing mid-February for their moulting grounds on
the sea ice. chinstrap penguins depart for a pre-moult foraging trip
towards the end of February and return to land in order to moult, before
departing again for their overwinter trip [\@Hinke2015;
\@Hinke2019](Figure%202). Conversely, gentoo penguins appear to remain
near their breeding colonies overwinter
[@korczak-abshireCoastalRegionsNorthern2021].

We use the Argos-CLS PTT telemetry data provided by the supporting
studies to characterise the actual at-sea habitat used, in the context
of the relative stage of breeding for each species (though we also
recommend @Warwick-Evans2018 and Lowther et al. (this meeting) amongst
other work, for further quantification of foraging behaviour of breeding
penguins in this area). For each species, we refrain from undertaking
extensive state-space modelling of location errors and merely exclude
locations with a "Z" error class, accepting the remaining locations had
varying degrees of uncertainty around them, then calculated the 99%
Minimum Convex Polygon (home range) using the R package *adehabitatHR*
and calculate their associated areas in $nm^2$. For chinstrap penguins
at Cape Shireff, this equated to a home range area of \~$4,782nm^2$, or
only 23% of the gSSMU to which their performance metrics are indexed
against [@Watters2020]. For the same species at Copacabana the 99% MCP
home range is 2,905$nm^2$, or \~19% of gSSMU 1 in the Bransfield Strait.
Similarly for Adélie penguins, the breeding foraging range occupied
1,139$nm^2$ or only \~7% of the area of gSSMU #1. After breeding,
available overwinter PTT telemetry and light geolocating data on
chinstrap and Adélie penguins suggests a wide dispersal westwards into
the Pacific sector of the Southern Ocean, and eastwards into the Weddell
Sea and Atlantic sectors, with a relatively small proportion of
chinstraps from the study sites remaining within 500km of their breeding
colonies [@Hinke2019]. Yet despite the evidence supporting widescale
post-breeding migration of both Adélie and chinstrap penguins, the model
used by @Watters2020 constrains both species from Copacabana to gSSMU #1
and chinstraps from Cape Shireff to gSSMU #2 over winter (Supplementary
Material 1 & 2, code lines 258 to 279). This has the effect of
constraining the variability in performance indices from these species
to LHR, LKB and ONI over winter in areas where the species has a
demonstrated tendency to migrate away from (Figure 2). This is
particularly important given that the fishery can now be characterised
with a late autumn/early winter start which places a seasonal element on
LHR towards increased values in the winter (Figure 5).

Our preliminary review thus far raises two areas of concern. Firstly,
that the scales at which "local" predictors are summarised are in some
cases almost 15 times larger than the habitat exploited by the penguins
monitored. Local Harvest Rate is a function of the catch and its
distribution; we demonstrate catch distribution varies across breeding
seasons within the original gSSMU, using available C1 Catch and Effort
data during the austral summer period, relevant to the breeding season
and thus centrally foraging Adélie and chinstrap penguins between 2009
and 2018 for Subarea 48.1 (Figure S1).

Secondly, that the known overwinter migratory behaviour of Adélie and
chinstrap penguins are poorly reflected in the model formulation. To
demonstrate the impact that these ecological assumptions have on the
model output, we rerun the model of @Watters2020 with modified code. To
avoid an overly burdensome paper, we shortly summarise those code
changes here, and if requested during the meeting we are happy to
include the rmarkdown version of this paper with the modified code in
place, or submit the modifications to the meeting in some other format.

We also note an additional coding error that may influence how the
original, unmodified results are interpreted. In summarising the model
outputs into boxplots, the text in the paper seemingly classifies the
"Worst Case" with "neutral" ONI (${-0.5}$ $^{\circ}$C \< ONI \< 0.5
$^{\circ}$C; LKB \> 1 Mt; and LHR $\geqslant$ 0.1) and the code relating
to developing the original manuscript Figure 2 (Supplementary Material
1, lines 661-663) uses Parameter set 36 from the output dataframe, which
actually reflects a "warm" ONI component (\> 0.5 $^{\circ}$C; LKB \> 1
Mt; and LHR $\geqslant$ 0.1). Yet the discussion in @Watters2020 also
suggests that the likelihood of their "Worst Case" includes future
warming (see Figure 3 below)

We agree that any "Worst Case" should reflect ENSO conditions into the
future under a warming climate. However, climate change is likely to
increase ENSO in amplitude - both El Niño (ONI "warm") and La Niña (ONI
"cold") [@capotondiUnderstandingENSODiversity2015]. How this increasing
amplitude can be integrated appropriately into the presented modelling
framework to match with long-term predicted mean performance of
predators has not been explored yet. As such, and for the sake of
comparison with the original study, we maintain the authors designation
of ONI "neutral" when rendering the "Worst Case" boxplots, though
caution that this is unlikely to be a realistic assumption

## Modifications

1.  We scale the gSSMU LKB to the SSMU that the summer tracking data
    indicate penguins occupied. To do this, we calculate the area
    ($nm^2$) of the SSMU for which the predator occupies and the gSSMU
    to which it is assigned, then create a scaling ratio. For example,
    we scale LKB for Cape Shireff chinstrap penguins solely to ADPDW
    (Figure 1) by multiplying the gSSMU LKB by the areal ratio of
    ADPDW/gSSMU #2. We then select the corresponding SSMU catch values
    provided in @Watters2020 (Supplementary Info) to estimate SSMU-scale
    LHR. We also caution that while considering the gSSMU scale of
    harvesting as inappropriate for "local" effects, even the SSMU-scale
    catch levels likely do not reflect pressures at scales relevant to
    breeding penguins (Supplementary Figure 1).\
2.  We remove Adélie and chinstrap penguins from the model formulation
    over winter; that is, we attribute each species as "NA" during
    winter (to account for dispersal after breeding), thus removing them
    from association with any gSSMU.\
3.  The authors place LKB/LHR values in March into the "summer" period.
    However fishing effort over the period that performance indices are
    available is not uniform over the thirty year period, with catch
    over the preceding decade tending towards a nonlinear increase from
    the middle of March and three years where catch rates increased
    rapidly from the beginning of the month (Figure 4). Given the highly
    variable rates of catch throughout the study period, we run
    scenarios that classify March as either summer or winter to reflect
    the linkage between March and the breeding state of penguins i.e.
    Adélie and chinstrap penguins have either migrated out of the area
    or have ceased to be centrally foraging species by March.

Thus we reformulate the underlying assumptions above into a new model
construct, in which performance indices from gentoo, chinstrap and
Adélie penguins during the summer are included, but Adélie and chinstrap
penguins cease to be centrally foraging species after breeding and
migrate out of the area. The performance indices are matched in space
and time but using SSMU level estimates of LKB and LHR. We re-run the
model that includes imputed values for LKB in years where survey data
are missing. We further consider two alternatives for considering March,
either in a) summer or b) winter.

We present the outputs both in the same boxplot format as Figure 2 in
the original manuscript, and as individual cases grouped and
colour-coded as ONI "warm" ($\geqslant$ 0.5; red), ONI "neutral" (-0.5
\< ONI \> +0.5; white) and ONI "cold" (\< -0.5; blue). We also recreate
the original marginal probabilities in Table 1 of @Watters2020, and two
additional tables in the same format with the probabilities extracted
from our reformulated model, the difference between the latter two
tables reflecting whether March is in summer or winter.

## Results

From the original @Watters2020 model, the probability that the Worst
Case would cause penguin performance indices to drop below their
long-term mean was 77%, while relative to the Best Case there was a 93%
probability that penguin performance would decline as a response to high
LHR. Similarly, there was a 99% probability that high LHR and LKB under
neutral ONI ("Worst Case", though see above for comments on this) would
drive penguin peformance to fall below its long term mean (Table 1).

Our reformulation displays a rather different picture, and while we
refrain from providing an exhaustive in-text comparison, we highlight a
few examples here. Comparing the original model outputs with ours,
relative to the "Best Case", the probability of negative impacts to
penguins due to high LHR dropped precipitously from $\geqslant$ 93% to
37% (Table 3). In other words, when considering the migration of
penguins in accordance with their known ecology (Figure 2), the relative
probability of negative impact of LHR drops from a near-certainty to
1-in-3 (Table 2 and 3). Given the temporal separation between fishing
and penguin breeding over the preceding decade, our results are
unsurprising.

The probability that the effects of warm or neutral ONI would be more
detrimental to penguin performance were greater than for the Worst Case
(Table 2 and 3). When we consider the marginal effects of neutral ONI
and high LHR, the probabilities that the former would negatively impact
penguin performance below the long-term mean was 4 times greater than
the impact of high LHR (Table 2 and 3). Looking at the case-by-case and
selected plots in Figure 4 the overwhelming dominace of the ONI state
can clearly be seen. La Niña ("cold" ONI) conditions resulted in
predictive probabilities of performance that were equal to, or
surpassing, those of the Best Case irrespective of increased LKB or LHR.
Even more counterintuitively, an increase in LHR to even high levels has
a lower probability of decreasing penguin performance than that of the
Best Case (Table 2 and 3). However, it is important to note that overall
our intention is not to suggest that increased fishing is beneficial;
merely that when the model is reconditioned on ecological knowledge, the
outputs in its current formulation should be treated with caution.

In summary, Watters et al. (2020) believe that penguins are responding
to both the environment and fishing. We agree that penguins are
responding to the environmental changes, however we believe that the
fishery effect is flawed because the scales at which their model
incorporates fishing bear no relevance to the scales at which penguins
exploit (Figure S1). The penguin performance in the orginal model was
also insensitive to marginal changes in LKB whichc corroborate previous
failed attempts to parameterise functional responses of penguins. This
insensitivity is in line with our results, but we propose that even the
SSMU scale is inappropriate for matching food availability and
harvesting pressure to predator performance (Figure S1).

In light of these findings, and the scales of management originally
proposed by us in WG-EMM 2019/18, we support the direction of
discussions during WG-ASAM this year to consider spatial scales of
management to areas in which the fishery operates, rather than at the
Subarea level.

# @Kruger2021 / WG-EMM 2019/10

The key objective of the paper by @Kruger2021 is to examine the
potential synergistic effects of climate change and increased fishing
activity in recent decades on the breeding performance of chinstrap and
gentoo penguins. The authors make the implicit assumption that there has
been a general decrease in krill density in response to climate change,
although this is still a topic of debate and is not supported by recent
large-scale surveys in the Scotia Sea (SG-ASAM 2019/08 Rev.1).

To address this topic, the authors fit a Generalized Linear Mixed
Effects model of the general form:
$$\lambda=catch*SAM+(1|colony\text{ }ID)$$ where $\lambda$ is an index
of change in penguin breeding performance, $catch$ is annual krill
catch, $SAM$ is the Southern Annular Mode index, and the term in
brackets indicate a random intercept term by colony. We would like to
discuss some points regarding both the model formulation and the input
data that we believe raise some potential concerns about the overall
approach and the conclusions drawn. Based on the issues we raise here,
we would welcome the opportunity to collaborate openly on a) recreating
these analyses b) testing their sensitivity to the assumptions made and
c) develop alternative approaches to alleviate these issues and provide
a less biased result. Below we go through these issues in some detail.
Unlike in the case of @Watters2020, scripts are not provided for the
analyses done by @Kruger2021, and therefore we have not been able to
recreate their analyses or test various aspects of data input,
underlying assumptions and alternative model formulations. Additionally,
there appear to be some discrepancies between the data provided in the
supplementary material and what was actually used in the paper.

## Response variable: Penguin breeding performance

As the basis for the index of change in breeding performance
($\lambda$), @Kruger2021 use data on the number of occupied nests
(breeding pairs) counted at a large number of sites throughout the
Antarctic Peninsula collected between 1980 and 2017. These data are
available from the Mapping Application for Penguin Populations and
Projected Dynamics (MAPPPD) data archive (www.penguinmap.com;
@Humphries2017). @Kruger2021 include count data on occupied nests based
on surveys carried out in November or December, reflecting the early
breeding season. They further subset the data to include only colonies
for which at least 2 survey estimates are available throughout the
38-year period under consideration (i.e. 1980-2017). These data are
provided in the supplementary materials for the paper. Based on the raw
counts, they calculate an index of temporal variation in population
growth rate using: $$\lambda_{std}=((n_b/n_a)/years_{b-a}-1$$ where $n$
is the number of breeding pairs counted in Nov-Dec of a given year, $b$
and the number of breeding pairs counted in the nearest previous year,
$a$, in which a Nov-Dec survey was conducted, divided by the interval
between surveys (i.e. $b-a$). While this index may be a robust index of
relative population change, the authors then convert $\lambda_{std}$
into a binary index, $bin\lambda_{std}$ that takes the value 1 for
negative growth and 0 for positive growth. The rationale is that this
value can be interpreted as the probability of population decline in
response to catch and environmental change. However by only taking the
sign of the change and creating a binary response the authors completely
ignore the magnitude of the absolute or relative change in population
size; that is, a decline of 1% or 99% of the population size in year $a$
is considered equivalent in the model.

## Predictor variables: Krill catch and SAM

As in the case of @Watters2020, @Kruger2021 also use CCAMLR C1 Catch and
Effort data from the krill fishery to estimate fishing pressure, but in
this case only hauls within a 30km radius are considered for each
specific colony. This selection is based on previous observations that
foraging of pygoscelid penguins is more probable within 30 km of the
colonies during the breeding season [@Warwick-Evans2018]. While they
initially summarise these data within distinct time periods (reflecting
different important stages of the penguin annual cycle), these are only
used for illustrative purposes [Fig 3 in @Kruger2021]. When modelling
the effect of fisheries on population response, the authors instead use
accumulated annual catches within these 30km areas, making the
assumption that the number of breeding penguins counted in a given
survey is affected by local resource availability, also during the
non-breeding period in winter. While this might be valid for gentoo
penguins which appear to remain close to the breeding colonies also
outside the breeding season
[@korczak-abshireCoastalRegionsNorthern2021], it is questionable how
appropriate this is for chinstraps that have displayed tendencies to
disperse much more widely during winter (see above section and
references therein). An additional issue with the spatial restriction of
catch data is that a high proportion of surveys are associated with
accumulated annual catch rates = 0. While this may not pose a serious
problem for chinstraps (`r round(100*noCatch[1,3]/noCatch[1,2])`% of
colonies have had some level of catch within their 30km radius) the
problem may be quite serious for gentoos
(`r round(100*noCatch[2,3]/noCatch[2,2])`% of colonies had catch within
a 30km radius).

The authors use monthly data on the Southern Annular Mode (SAM) index to
represent environmental variability
[@doddridgeModulationSeasonalCycle2017;
@kwokSpatialPatternsVariability2002]. Based on an observed 0-3 month
lagged correlation between SAM and relevant local climate variables
(fractional sea ice cover, open water sensible heat flux and sea level
air pressure), the authors exclude SAM values for months coinciding with
the breeding season. As discussed in the review of @Watters2020 above,
the climactic conditions over the WAP are a function primarily of the
Amundsen Sea Low and its interactions with both ENSO and SAM, as well as
the bathymetry of the local areas. There is a rich scientific literature
addressing climate-driven hydrographic variability in the WAP , none of
which is considered in this paper.

## Spatio-temporal mismatch

While the above sections describe some of our specific concerns with the
various input data to the GLME, our main concern relates to issues of
mismatch between these various data in space and time. Given the
different data selections and transformations, the specific model
specification presented in @Kruger2021 is:
$$bin\lambda_{std}=catch_y*SAM+(1|colony\text{ }ID)$$ where the
subscript $y$ denotes the accumulated krill catch within 30km of each
colony over the year last survey in a survey interval (i.e. year $b$
using the notation in the performance equation above). Similarly, the
SAM index is the mean SAM index over almost the same period, but
excluding the three months of the breeding season itself. To clarify
this, we change the subscripts in the model equation:

$$bin\lambda_{std_I}=\sum_{i=0}^{i=12}{catch_i}*\frac{\sum_{i=0}^{i=8}{SAM_i}}{9}+(1|colony\text{ }ID)$$

Here, $I$ represents the survey interval, expressed in months rather
than years, while $i$ represents the number of months prior to the start
of the survey carried out in the last year of the interval $I$. While
$i$ is always $\leqslant$ 12, $I$ is always $\geqslant$ 12. In fact,
based on the @Kruger2021 supplementary dataset, $I>12$ in \~
`r round(gaptab[2,1])`% and `r round(gaptab[2,2])`% of all intervals for
`r colnames(gaptab)[1]`s and `r colnames(gaptab)[2]`s respectively
(Figure 5). This illustrates the substantial and increasing issue of
temporal mismatch between the response variable and the explanatory
variables with increasing $I$. As $I$ increases, the difference in the
number of breeding pairs between the first and last year of an interval
will increasingly be a function of the catch rates and environmental
conditions in ALL years in the interval, not just the final year. In the
extreme case, it is highly unlikely that an overall decrease in breeding
population size of `r gaps$common.name[which.max(gaps$yrdiff)]`s at
`r peng$site.name[match(gaps$site.name[which.max(gaps$yrdiff)], peng$site.id)]`
between `r max.krug$year[which.max(diff(max.krug$year))]` and
`r max.krug$year[which.max(diff(max.krug$year))+1]` is in large part a
response of local catch rates and SAM index in the single year preceding
the `r max.krug$year[which.max(diff(max.krug$year))+1]` breeding season
survey. In addition, with increasing $I$, the probability that a change
in number of breeding pairs has been monotonous and linear throughout
the entire interval becomes less likely, and the probability decreases
that $bin\lambda_{std_I}$ has the same sign as the actual (unobserved)
change between the last two breeding seasons in the interval.

## Possible tests and alternative modelling approaches

To address the issues raised above, the analyses of @Kruger2021 should
be re-run with e.g. random subsets of the data or with data
substitutions/permutations of the survey estimates. For instance,
additional simulated surveys could be inserted into intervals $I>12$,
specifically such that it changes the monotonous trend over the interval
to change the sign of the associated $bin\lambda_{std_I}$. Additionally,
the 30km radius for catch rates could be relaxed, at least for months
outside of the breeding period, when especially chinstraps are known to
disperse widely throughout the wider West Antarctic shelf regions (see
Fig. 2).

In general, we strongly argue that the spatio-temporal mismatch between
the various input data must be explicitly accounted for in some way. One
relatively simple approach would be to relax the temporal restriction of
covariate data, such that catch rates and SAM values for all
years/months within an interval between surveys are combined, rather
than only using values from within the last year before the next survey.
However, the most appropriate general strategy would be to include an
approach for estimating spatio-temporal autocorrelation structures in
the data, and exploiting these structures explicitly in the modelling.
For instance, colonies closer could "borrow strength" from each-other in
cases of long intervals between consecutive surveys at some colonies,
especially for survey estimates of breeding population size. Additional
consideration of lagged recruitment (fledging to reproductive age) is
also needed, alongside the ability to detect it given irregular
surveying effort and methods for longitudinal detection (such as banding
or other permanent marking). We would very much welcome the opportunity
to discuss various options for such approaches directly with the
authors.

# Discussion

Our preliminary review of the evidence supporting localised effects of
fishing coupled with broad-scale climactic phenomena having an impact on
the vital statistics of pygoscelid penguins (performance and abundance
trends) are based on assumptions that potentially do not reflect current
knowledge of penguin breeding phenology and movement.

Of greatest concern, however, is that the interpretation of model
outputs from both approaches (either from both the original studies or
the modified parameters we describe) are under boundary conditions that
we feel are not appropriate. Both approaches consider only the fishery
and broad-scale climate phenomena as the only two causes of krill
abundance variability at geographic scales relevant to penguins. Neither
study considers, for example, the impact of rebounding baleen whale
populations or migratory male Antarctic fur seals beyond brief
mentioning. Humpback whales have increased in abundance throughout the
life of the krill fishery, and there are sufficient telemetry and
distance sampling studies in the scientific literature to demonstrate
the degree and significance of spatiotemporal overlap with breeding
penguin populations (see @Santora2013, @Lowther2020, Oosthuizen et al.,
Johannessen et al., Lowther et al. submitted to this meeting, and Figure
S2 as examples). Importantly, the distribution of these and numerous
other unconsidered competitors is not uniform in either space or time,
and their impact on local availability of krill is likely to be
considerable. It is also worth noting that neither study considers the
impact of climate on the terrestrial breeding grounds, such as chick
mortality through "wetting down" by increased rainfall
[@chapmanMarineTerrestrialFactors2011].

Similarly, the utilisation of broad-scale climatological phenomena to
characterise impacts at scales that predators are dependent upon is
problematic. The Amundsen Sea Low (ASL) is the dominant climate feature
for the western Antarctic Peninsula. The El Niño-Southern Oscillation
modulates the ASL, with El Niño (La Niña) shallowing (deepening) its
pressure, causing more northwesterly (southeasterly) winds and upwelling
(restricted influx) of Circumpolar Deep Water onto the shelf. The
Southern Annular Mode also influences the pressure of the ASL, with the
current trend of negative SAM constructively (destructively) interfering
with ASL when in phase with El Niño (La Niña) events (e.g. @Clem2016).
The result is a set of above-surface climate conditions that drive
changes in water mass intrusion that is in turn dependent on
*interactions* between two climate processes. The bathymetry of the
Antarctic Peninsula which also influences the hydrographic conditions is
complex (particularly at scales that are important to centrally-foraging
predators such as penguins) and the structuring of krill aggregations in
time and space in the WAP have been linked to mesoscale circulation
processes [@santoraKrillSpaceComparative2012], which are unlikely to be
uniformly affected by macroscale processes.

Our work into the future will progress along three lines, and we welcome
any and all offers of collaboration into this work. Firstly, we will
progress this debate into the scientific literature in order to ensure a
balanced discussion occurs in that forum. Secondly, we will be examining
in further detail some of the additional predictors used and their
efficacy, the modelling frameworks into which they are brought, and how
their incorporation influences the interpretation of the responses.
Finally, we shall also be exploring alternative modelling approaches
that reflect more of the physical and biological complexity of the
system in question. In all cases, our goal is to ensure that the best
available objective scientific evidence is presented to our
environmental managers and, where appropriate, flag that disagreement
exists. Our paper is intended to be viewed in this light to generate
constructive dialogue that addresses our common concern of the potential
for localised fishing to impact dependent aspects of the ecosystem.
\newpage  

```{r Penguin distribution plots, out.width="65%",fig.align="centre",fig.cap="Penguin foraging behaviour during summer breeding, derived from available ARGOS-CLS PTT data presented in Hinke et al. 2017. A) Chinstrap penguins from Cape Shireff (blue) and Copacabana (green) truncated at $10^{th}$ March in line with known phenology (Black 2016; Lowther et al.(this meeting).  Elongated grey track represents a single animal) B) Adélie penguins truncated to the end of January and C) gentoo penguins until \\textasciitilde{}August, representing all available PTT data provided. The SSMU are combined and coloured according to gSSMU (red; gSSMU 2, purple; gSSMU 1) with chinstrap and Adélie penguin 99\\% MCP home ranges occupying between 7-19\\% of the gSSMU to which they were assigned.", echo=FALSE}

knitr::include_graphics("./Watters EMM figures/Penguin distributions.png")

```

```{r Overwinter penguin  plots, fig.align="centre", fig.cap="A) Distribution of overwinter movement for chinstrap penguins, relative to the gSSMU's to which they were attributed, created from telemetry data available in Hinke et al. 2019.  B) Adélie and chinstrap penguin movement recorded by light geolocators, highlighting the large longitudinal range both species disperse through at the end of breeding (taken from Hinke et al. 2015).  In the original model formulation by Watters et al. 2020, the winter performance indices for both species are matched to macroscale levels of ONI variability but gSSMU-scale estimates of LKB and LHR.", out.width="75%", echo=FALSE}

knitr::include_graphics("./Watters EMM figures/Overwinter pengo distributions.png")
```

```{r Watters original and mistake, echo=FALSE, fig.align="centre", out.width="75%", fig.cap="Original Figure 1 plot from Watters et al. 2020 with A) Neutral ONI and B) B) Warm ONI constituting the Worst Case selected.  C) Displays the original case-by-case plots recreated from the paper, with Case 12 representing the intention while data from Case 18 was selected for rendering the boxplot.  Note that the expected performance under neutral ONI Worst Case is poorer than under the warm ONI that was presented in the original paper.  Henceforth, to facilitate comparison, we refer to the ONI Neutral plot however we consider this unrealistic if the intention is to portray a Worst Case of a continuing warming climate."}

knitr::include_graphics("./Watters EMM figures/Watters original and mistake.png")

```

```{r Scenario plot 1, out.width="100%", fig.align="left", echo=FALSE, fig.cap="Model output for the alternatve Watters et al. 2020 scenario outlined above (all species initially present, Adélie and chinstrap penguins migrate out of the area after breeding, LKB and LHR rescaled to SSMU and March included in summer or winter).   Selected cases as per Watters et al. 2020 for March in A) Summer and B) Winter are provided, with the corresponding case-by-case boxplots presented beneath.  Boxplots are colour-coded by ONI state (red=warm, white=neutral, blue=cold).  In all cases, the marginal effect of ONI dominated the expected performance of penguins against their long-term mean, irrespective of LKB or LHR."}

knitr::include_graphics("./Watters EMM figures/All spp summer then winter 37.png")
```

```{r Scenario plot 2, out.width="100%", fig.align="left", echo=FALSE, eval=FALSE, fig.cap="Model output for Watters et al. 2020 Scenario \\#2 outlined above (all species initially present,Adélie and chinstrap penguins migrate out of the area after breeding, LKB and LHR rescaled to SSMU and March included in summer or winter).   Selected cases as per Watters et al. 2020 for March in A) Summer and B) Winter are provided, with the corresponding case-by-case boxplots presented beneath.  Boxplots are colour-coded by ONI state (red;warm, white;neutral, blue;cold).  In all cases, the marginal effect of ONI dominated the expected performance of penguins against their long-term mean, irrespective of LKB or LHR."}

knitr::include_graphics("./Watters EMM figures/ADE and CHIN summer 40 41.png")
```

```{r gapCheck, echo=F, fig.show="hold", fig.pos='center', fig.cap='Frequency distribution (percent) of intervals between consecutive breeding surveys for chinstrap and gentoo penguins, taken from the supplementary data for Kruger et al 2021.'}

# pander::pander(gaptab, caption='Frequency distribution (percent) of intervals between consecutive breeding surveys for chinstrap and gentoo penguins used by Kruger et al 2021.', justify='center')

 

par(las=2)

plot(gaptab[,1], type='n', axes=F,

     xlim=c(0.5, nrow(gaptab)+0.5), ylim=c(0, ceiling(max(gaptab))),

     ylab='Percent of observed intervals', xlab='')

axis(2)

axis(1, at=c(1:nrow(gaptab)), labels=dimnames(gaptab)[[1]])

abline(h=seq(0, ceiling(max(gaptab)), by=10), lty=2, col='grey')

box()

plotrix::axis.break(breakpos=10.5)

plotrix::axis.break(breakpos=12.5)

rect(c(1:nrow(gaptab))-0.4, rep(0, nrow(gaptab)), c(1:nrow(gaptab)), gaptab[,1], col=RColorBrewer::brewer.pal(3, 'Dark2')[1])

rect(c(1:nrow(gaptab)), rep(0, nrow(gaptab)), c(1:nrow(gaptab))+0.4, gaptab[,2], col=RColorBrewer::brewer.pal(3, 'Dark2')[2])

legend('topright', pch=22,

       pt.bg=RColorBrewer::brewer.pal(3, 'Dark2')[c(1,2)],

       dimnames(gaptab)[[2]])

```

```{r Scenario plot 3, out.width="100%", fig.align="left", echo=FALSE, eval=FALSE, fig.cap="Model output for Scenario \\#3 outlined above (all species initially present,Adélie and chinstrap penguins migrate out of the area after breeding, LKB and LHR rescaled to SSMU and March included in summer or winter).   Selected cases as per Watters et al. 2020 for March in A) Summer and B) Winter are provided, with the corresponding case-by-case boxplots presented beneath.  Boxplots are colour-coded by ONI state (red;warm, white;neutral, blue;cold).  In all cases, the marginal effect of ONI dominated the expected performance of penguins against their long-term mean, irrespective of LKB or LHR."}

knitr::include_graphics("./Watters EMM figures/Gentoo only 38 39.png")
```

```{r March Subarea 48.1 fishing plot, out.width="60%", fig.align="centre", fig.cap="Daily accumulated catch (and fitted LOESS smooth curves) in Subarea 48.1 between 20$^{th}$ February and March 31$^{st}$ between A) 1990-2010 and B) 2010 to 2020. Catch in the Subarea was relatively consistent during the latter stages of penguin breeding at approximately 250tonnes/d (NOTE: different scaling of catch on y-axis between plots).  However, since 2010 there has been a tendency for the fishery to increase its effort in the Subarea, starting around the middle of March. C) During this latter period, the fishery increased effort earlier on three occasions (2013, 2015 and 2016), starting before the beginning of March.", echo=FALSE}

#knitr::include_graphics("./Watters EMM figures/catch march 481.png")
```

\blandscape

```{r Table 1 Scenario Original, warning=FALSE, echo=FALSE}
###Summary Table 1 to replicate Watters----
keepers = c(37:74)
pt = d.org %>%
  dplyr::group_by(Parameter) %>%
  dplyr::summarize(mean(value)) %>%
  dplyr::rename(.,c(mean = `mean(value)`)) %>%
  dplyr::slice(37:74)

best.case.names = c("Best case", "ONI Neutral", "ONI warm", "LKB High", "LHR medium", "LHR high", "Worst case")
best.case = c(NA,pt$mean[4], pt$mean[5], pt$mean[1], pt$mean[2], pt$mean[3], pt$mean[6])
oni.range = c(NA,NA,NA, pt$mean[9], pt$mean[7], pt$mean[8], NA)
oni.warm = c(NA, NA, NA, pt$mean[12], pt$mean[10], pt$mean[11], NA)
long.term.posterior = c(pt$mean[13], pt$mean[17], pt$mean[18], pt$mean[14], pt$mean[15], pt$mean[16], pt$mean[19])
long.term.predicted = c(pt$mean[32], pt$mean[36], pt$mean[37], pt$mean[33], pt$mean[34], pt$mean[35], pt$mean[38])

table.original.scenario = round(tibble(best.case, oni.range, 
                                oni.warm, long.term.posterior,long.term.predicted),2) %>%
  dplyr::mutate(Effects = best.case.names) %>%
  dplyr::select(6,1,2,3,4,5)

knitr::kable(table.original.scenario, booktabs=TRUE,  col.names = c("Effects", 
             "Best Case", 
              "-0.5 $^\\circ$ C < ONI < +0.5 $^\\circ$ C",
              "ONI $\\geqslant+0.5$", 
             "Long-term $\\mu$", 
              "Long-term predicted $\\mu$"),
             longtable=TRUE, align="lccccc", caption = "Original table in Watters et al. 2020.  In this and all subsequent tables below, the posterior and posterior predictive probabilities that the expected performance of penguins given the effects in the left hand column are less than the expected performance given the drivers in the column headings are provided. Worst Case is represented by neutral ONI; LHR  $\\geqslant$ 0.1; and LKB $\\geqslant$ 1Mt.  The Best Case is represented by La Niña conditions, low LKB and low LHR.", escape=FALSE) %>%
   kable_styling(bootstrap_options = "striped", full_width = F)

```

```{r Table 1 Scenario 37a, warning=FALSE, echo=FALSE}
####Scenario 37a Table 1----
keepers = c(37:74) #keep just Prob and Prob.new parameters
pt = d37a %>%
  dplyr::group_by(Parameter) %>%
  dplyr::summarize(mean(value)) %>%
  dplyr::rename(.,c(mean = `mean(value)`)) %>%
  dplyr::slice(37:74)

best.case.names = c("Best case", "ONI Neutral", "ONI warm", "LKB High", "LHR medium", "LHR high", "Worst case")
best.case = c(NA,pt$mean[4], pt$mean[5], pt$mean[1], pt$mean[2], pt$mean[3], pt$mean[6])
oni.range = c(NA,NA,NA, pt$mean[9], pt$mean[7], pt$mean[8], NA)
oni.warm = c(NA, NA, NA, pt$mean[12], pt$mean[10], pt$mean[11], NA)
long.term.posterior = c(pt$mean[13], pt$mean[17], pt$mean[18], pt$mean[14], pt$mean[15], pt$mean[16], pt$mean[19])
long.term.predicted = c(pt$mean[32], pt$mean[36], pt$mean[37], pt$mean[33], pt$mean[34], pt$mean[35], pt$mean[38])

table.scenario.37a = round(tibble(best.case, oni.range, 
                                oni.warm, long.term.posterior,long.term.predicted),2) %>%
  dplyr::mutate(Effects = best.case.names) %>%
  dplyr::select(6,1,2,3,4,5)

names(table.scenario.37a) = c("Effects", 
                         "Best Case", 
                         "-0.5 $^\\circ$ C < ONI < +0.5 $^\\circ$ C",
                         "ONI $\\geqslant+0.5$", 
                         "Long-term $\\mu$", 
                         "Long-term predicted $\\mu$")

knitr::kable(table.scenario.37a, booktabs=TRUE,  col.names = c("Effects", 
             "Best Case", 
              "-0.5 $^\\circ$ C < ONI < +0.5 $^\\circ$ C",
              "ONI $\\geqslant+0.5$", 
             "Long-term $\\mu$", 
              "Long-term predicted $\\mu$"),
             longtable=TRUE, align="lccccc", caption = "Posterior and posterior predictive probabilities extracted from the model output for alternatve Watters et al. 2020 scenario outlined above with March attributed to winter (Adélie and chinstrap penguins migrate out of the area after breeding, LKB and LHR rescaled to SSMU). Under this scenario, performance against the long term mean is worst for neutral and warm ONI conditions.", escape=FALSE) %>%
  kable_styling(bootstrap_options = "striped", full_width = F)# %>%
 # row_spec(2:3, color="red")

```

\elandscape
\blandscape

```{r Table 1 Scenario 37b, warning=FALSE, echo=FALSE}
###Summary Table 1 to replicate Watters----
keepers = c(37:74)
pt = d37b %>%
  dplyr::group_by(Parameter) %>%
  dplyr::summarize(mean(value)) %>%
  dplyr::rename(.,c(mean = `mean(value)`)) %>%
  dplyr::slice(37:74)

best.case.names = c("Best case", "ONI Neutral", "ONI warm", "LKB High", "LHR medium", "LHR high", "Worst case")
best.case = c(NA,pt$mean[4], pt$mean[5], pt$mean[1], pt$mean[2], pt$mean[3], pt$mean[6])
oni.range = c(NA,NA,NA, pt$mean[9], pt$mean[7], pt$mean[8], NA)
oni.warm = c(NA, NA, NA, pt$mean[12], pt$mean[10], pt$mean[11], NA)
long.term.posterior = c(pt$mean[13], pt$mean[17], pt$mean[18], pt$mean[14], pt$mean[15], pt$mean[16], pt$mean[19])
long.term.predicted = c(pt$mean[32], pt$mean[36], pt$mean[37], pt$mean[33], pt$mean[34], pt$mean[35], pt$mean[38])

table.scenario.37b = round(tibble(best.case, oni.range, 
                                oni.warm, long.term.posterior,long.term.predicted),2) %>%
  dplyr::mutate(Effects = best.case.names) %>%
  dplyr::select(6,1,2,3,4,5)

knitr::kable(table.scenario.37b, booktabs=TRUE,  col.names = c("Effects", 
             "Best Case", 
              "-0.5 $^\\circ$ C < ONI < +0.5 $^\\circ$ C",
              "ONI $\\geqslant+0.5$", 
             "Long-term $\\mu$", 
              "Long-term predicted $\\mu$"),
             longtable=TRUE, align="lccccc", caption = "Posterior and posterior predictive probabilities extracted from the model output for alternatve Watters et al. 2020 scenario outlined above with March attributed to summer (Adélie and chinstrap penguins migrate out of the area after breeding, LKB and LHR rescaled to SSMU). Under this scenario performance against the long term mean is also worst for neutral and warm ONI conditions.", escape=FALSE) %>%
   kable_styling(bootstrap_options = "striped", full_width = F)# %>%
#  row_spec(2:3, color="red")

```

```{r Table 1 Scenario 40 Chin Adel only plus migration March winter, eval=FALSE, warning=FALSE, echo=FALSE}
####Scenario 37a Table 1----
keepers = c(37:74) #keep just Prob and Prob.new parameters
pt = d40 %>%
  dplyr::group_by(Parameter) %>%
  dplyr::summarize(mean(value)) %>%
  dplyr::rename(.,c(mean = `mean(value)`)) %>%
  dplyr::slice(37:74)

best.case.names = c("Best case", "ONI Neutral", "ONI warm", "LKB High", "LHR medium", "LHR high", "Worst case")
best.case = c(NA,pt$mean[4], pt$mean[5], pt$mean[1], pt$mean[2], pt$mean[3], pt$mean[6])
oni.range = c(NA,NA,NA, pt$mean[9], pt$mean[7], pt$mean[8], NA)
oni.warm = c(NA, NA, NA, pt$mean[12], pt$mean[10], pt$mean[11], NA)
long.term.posterior = c(pt$mean[13], pt$mean[17], pt$mean[18], pt$mean[14], pt$mean[15], pt$mean[16], pt$mean[19])
long.term.predicted = c(pt$mean[32], pt$mean[36], pt$mean[37], pt$mean[33], pt$mean[34], pt$mean[35], pt$mean[38])

table.scenario.40 = round(tibble(best.case, oni.range, 
                                oni.warm, long.term.posterior,long.term.predicted),2) %>%
  dplyr::mutate(Effects = best.case.names) %>%
  dplyr::select(6,1,2,3,4,5)

names(table.scenario.40) = c("Effects", 
                         "Best Case", 
                         "-0.5 $^\\circ$ C < ONI < +0.5 $^\\circ$ C",
                         "ONI $\\geqslant+0.5$", 
                         "Long-term $\\mu$", 
                         "Long-term predicted $\\mu$")

knitr::kable(table.scenario.40, booktabs=TRUE,  col.names = c("Effects", 
             "Best Case", 
              "-0.5 $^\\circ$ C < ONI < +0.5 $^\\circ$ C",
              "ONI $\\geqslant+0.5$", 
             "Long-term $\\mu$", 
              "Long-term predicted $\\mu$"),
             longtable=TRUE, align="lccccc", caption = "Posterior and posterior predictive probabilities extracted from the model output for Scenario 2a (Adélie and chinstrap penguins migrate out of the area after breeding, gentoo penguins not included at all, LKB and LHR rescaled to SSMU and March included in WINTER). Under this scenario, performance against the long term mean is worst for neutral and warm ONI conditions.", escape=FALSE) %>%
  kable_styling(bootstrap_options = "striped", full_width = F) %>%
  row_spec(2:3, color="red")

```

\elandscape
\blandscape

```{r Table 1 Scenario 41 Chin Adel only plus migration March summer, eval=FALSE, warning=FALSE, echo=FALSE}
###Summary Table 1 to replicate Watters----
keepers = c(37:74)
pt = d41 %>%
  dplyr::group_by(Parameter) %>%
  dplyr::summarize(mean(value)) %>%
  dplyr::rename(.,c(mean = `mean(value)`)) %>%
  dplyr::slice(37:74)

best.case.names = c("Best case", "ONI Neutral", "ONI warm", "LKB High", "LHR medium", "LHR high", "Worst case")
best.case = c(NA,pt$mean[4], pt$mean[5], pt$mean[1], pt$mean[2], pt$mean[3], pt$mean[6])
oni.range = c(NA,NA,NA, pt$mean[9], pt$mean[7], pt$mean[8], NA)
oni.warm = c(NA, NA, NA, pt$mean[12], pt$mean[10], pt$mean[11], NA)
long.term.posterior = c(pt$mean[13], pt$mean[17], pt$mean[18], pt$mean[14], pt$mean[15], pt$mean[16], pt$mean[19])
long.term.predicted = c(pt$mean[32], pt$mean[36], pt$mean[37], pt$mean[33], pt$mean[34], pt$mean[35], pt$mean[38])

table.scenario.41 = round(tibble(best.case, oni.range, 
                                oni.warm, long.term.posterior,long.term.predicted),2) %>%
  dplyr::mutate(Effects = best.case.names) %>%
  dplyr::select(6,1,2,3,4,5)

knitr::kable(table.scenario.41, booktabs=TRUE,  col.names = c("Effects", 
             "Best Case", 
              "-0.5 $^\\circ$ C < ONI < +0.5 $^\\circ$ C",
              "ONI $\\geqslant+0.5$", 
             "Long-term $\\mu$", 
              "Long-term predicted $\\mu$"),
             longtable=TRUE, align="lccccc", caption = "Posterior and posterior predictive probabilities extracted from the model output for Scenario 1a (all species initially present,Adélie and chinstrap penguins migrate out of the area after breeding, LKB and LHR rescaled to SSMU and March included in summer). Under this scenario, performance against the long term mean is worst for neutral and warm ONI conditions.", escape=FALSE) %>%
   kable_styling(bootstrap_options = "striped", full_width = F)

```

\elandscape
\blandscape

```{r Table 1 Scenario 38 gentoo only March Winter, eval=FALSE, warning=FALSE, echo=FALSE}
####Scenario 38 Table 1----
keepers = c(37:74) #keep just Prob and Prob.new parameters
pt = d38 %>%
  dplyr::group_by(Parameter) %>%
  dplyr::summarize(mean(value)) %>%
  dplyr::rename(.,c(mean = `mean(value)`)) %>%
  dplyr::slice(37:74)

best.case.names = c("Best case", "ONI Neutral", "ONI warm", "LKB High", "LHR medium", "LHR high", "Worst case")
best.case = c(NA,pt$mean[4], pt$mean[5], pt$mean[1], pt$mean[2], pt$mean[3], pt$mean[6])
oni.range = c(NA,NA,NA, pt$mean[9], pt$mean[7], pt$mean[8], NA)
oni.warm = c(NA, NA, NA, pt$mean[12], pt$mean[10], pt$mean[11], NA)
long.term.posterior = c(pt$mean[13], pt$mean[17], pt$mean[18], pt$mean[14], pt$mean[15], pt$mean[16], pt$mean[19])
long.term.predicted = c(pt$mean[32], pt$mean[36], pt$mean[37], pt$mean[33], pt$mean[34], pt$mean[35], pt$mean[38])

table.scenario.38 = round(tibble(best.case, oni.range, 
                                oni.warm, long.term.posterior,long.term.predicted),2) %>%
  dplyr::mutate(Effects = best.case.names) %>%
  dplyr::select(6,1,2,3,4,5)

names(table.scenario.38) = c("Effects", 
                         "Best Case", 
                         "-0.5 $^\\circ$ C < ONI < +0.5 $^\\circ$ C",
                         "ONI $\\geqslant+0.5$", 
                         "Long-term $\\mu$", 
                         "Long-term predicted $\\mu$")

knitr::kable(table.scenario.38, booktabs=TRUE,  col.names = c("Effects", 
             "Best Case", 
              "-0.5 $^\\circ$ C < ONI < +0.5 $^\\circ$ C",
              "ONI $\\geqslant+0.5$", 
             "Long-term $\\mu$", 
              "Long-term predicted $\\mu$"),
             longtable=TRUE, align="lccccc", caption = "Posterior and posterior predictive probabilities extracted from the model output for Scenario 1a (all species initially present,Adélie and chinstrap penguins migrate out of the area after breeding, LKB and LHR rescaled to SSMU and March included in summer). Under this scenario, performance against the long term mean is worst for neutral and warm ONI conditions.", escape=FALSE) %>%
  kable_styling(bootstrap_options = "striped", full_width = F) %>%
  row_spec(2:3, color="red")

```

```{r Table 1 Scenario 39 gentoo only March Summer, eval=FALSE, echo=FALSE, warning=FALSE}
###Summary Table 1 to replicate Watters----
keepers = c(37:74)
pt = d39 %>%
  dplyr::group_by(Parameter) %>%
  dplyr::summarize(mean(value)) %>%
  dplyr::rename(.,c(mean = `mean(value)`)) %>%
  dplyr::slice(37:74)

best.case.names = c("Best case", "ONI Neutral", "ONI warm", "LKB High", "LHR medium", "LHR high", "Worst case")
best.case = c(NA,pt$mean[4], pt$mean[5], pt$mean[1], pt$mean[2], pt$mean[3], pt$mean[6])
oni.range = c(NA,NA,NA, pt$mean[9], pt$mean[7], pt$mean[8], NA)
oni.warm = c(NA, NA, NA, pt$mean[12], pt$mean[10], pt$mean[11], NA)
long.term.posterior = c(pt$mean[13], pt$mean[17], pt$mean[18], pt$mean[14], pt$mean[15], pt$mean[16], pt$mean[19])
long.term.predicted = c(pt$mean[32], pt$mean[36], pt$mean[37], pt$mean[33], pt$mean[34], pt$mean[35], pt$mean[38])

table.scenario.39 = round(tibble(best.case, oni.range, 
                                oni.warm, long.term.posterior,long.term.predicted),2) %>%
  dplyr::mutate(Effects = best.case.names) %>%
  dplyr::select(6,1,2,3,4,5)

knitr::kable(table.scenario.39, booktabs=TRUE,  col.names = c("Effects", 
             "Best Case", 
              "-0.5 $^\\circ$ C < ONI < +0.5 $^\\circ$ C",
              "ONI $\\geqslant+0.5$", 
             "Long-term $\\mu$", 
              "Long-term predicted $\\mu$"),
             longtable=TRUE, align="lccccc", caption = "Posterior and posterior predictive probabilities extracted from the model output for Scenario 1a (all species initially present,Adélie and chinstrap penguins migrate out of the area after breeding, LKB and LHR rescaled to SSMU and March included in summer). Under this scenario, performance against the long term mean is worst for neutral and warm ONI conditions.", escape=FALSE) %>%
   kable_styling(bootstrap_options = "striped", full_width = F)

```

\elandscape

```{r dataCompare, eval=F, echo=F}
pander::pander(compMat, caption='Number of colonies in final data subsets from data downloaded directly from MAAPD and the data in Kruger et al. 2021 supplementary material.', justify='center')
```

\newpage
\beginsupplement
\blandscape

# Supplementary material

```{r Supplementary Figure 1, echo=FALSE, fig.align="centre", out.width="80%", fig.cap="C1 Catch and Effort data for 2010 - 2018, for all catches during the period of the austral summer relating to Adélie and chinstrap penguins in Subarea 48.1 (i.e. up to $10^{th}$ March).  The telemetry data presented in Hinke et al. 2017 for chinstrap penguins at both Cape Shireff and Copacabana and the gSSMU used in the Watters et al. 2020 paper are superimposed to highlight the extreme variability in actual catch, relative to the scale of LHR used to reflect interactions with penguins.  Our reanalysis re-scaled LHR to the SSMU level, though we contend that for the purposes of matching predator data at appropriate spatial scales even this is too coarse a resolution."}

knitr::include_graphics("./Watters EMM figures/summer catch/Year by year catch.png")
```

\elandscape

```{r Supplementary Figure 2 other species plots, out.width="100%", fig.align="left", fig.cap="The summer distribution of foraging effort by A) adult female Antarctic fur seals (adapted from telemetry data available in Hinke et al. 2017), B) migratory adult male Antarctic fur seals (adapted from Lowther et al. 2020) C) humpback whales throughout December (adapted from Johannessen et al., this meeting) and D) nonbreeding adult Adélie penguins during the breeding season (adapted from data in Oosthuizen et al., this meeting). Potential effects of competitive overlap between pygoscelid penguins and other krill dependent predators, particularly those who have increased their abundance dramatically over the preceding 40 years, are excluded from both approaches, creating an unrealistic set of boundary conditions for interpreting the variance in penguin vital rates.", echo=FALSE}

knitr::include_graphics("./Watters EMM figures/Other spp distribution.png")
```

\newpage

```{r Supplementary Info Code, echo=FALSE, eval=FALSE, attr.source='.numberLines', caption="Code and modifications"}
####DATA PREP AND MODEL CODE (IMPUTATION OF BIOMASS = TRUE)----
#original paper here:
#https://doi.org/10.1038/s41598-020-59223-9
#requirements - raw Supplementary Files from original Watters et al. (2020) publication available here:
#https://www.nature.com/articles/s41598-020-59223-9#Sec8
# the analyses with imputation takes several hours - the scenarios outlined in the paper are provided as .csv
# files in the Zenodo repository provided which is open access via the DOI here (https://doi.org/10.5281/zenodo.5040114)
# and provided in the manuscript.
# the raw files to conduct the analyses from first prinicples are also available from the Watters et al.2020 manuscript 
#SCRIPT MODIFICATIONS:
#L. 225 - 233.  These changes modify the Acoustic biomass estimates by the ratio of SSMU / gSSMU
#L. 253.  Alter March to either Summer or Winter.  Currently set to Winter.
#L. 255 - 258.  Modify the gSSMU configurations to reflect only SSMU
#L. 284, 286 & 290.  Set CHPE and ADPE in WINTER to NA - removing from model / migration out of area
#L. 666.  Incorrect parameter set selection for "Worst Case" Fig 2 / "Selected Cases" plot.
library(tidyverse)
make.localhr.data<-function(trim=1,plot.winter=FALSE){
 # fledge weight (fwt)
 # bigger indicates better summer
 fwt<-read.csv("fweight.csv",header=TRUE,stringsAsFactors = FALSE)
 fwt<-tapply(fwt$WT,list(fwt$YEAR,fwt$PROJECT,fwt$SPECIES),mean)
 fwt<-data.frame(YEAR=rep(dimnames(fwt)[[1]],dim(fwt)[2]*dim(fwt)[3]),
                 PROJECT=rep(rep(dimnames(fwt)[[2]],each=dim(fwt)[1]),dim(fwt)[3]),
                 SPECIES=rep(dimnames(fwt)[[3]],each=dim(fwt)[1]*dim(fwt)[2]),
                 fwt=c(fwt),stringsAsFactors = FALSE)
 fwt$matchme<-paste(fwt$PROJECT,fwt$SPECIES,sep="|")
 tt<-tapply(fwt$fwt,list(fwt$matchme),mean,na.rm=TRUE)
 ttt<-tapply(fwt$fwt,list(fwt$matchme),sd,na.rm=TRUE)
 mean.fwt<-tt[match(fwt$matchme,names(tt))]
 sd.fwt<-ttt[match(fwt$matchme,names(ttt))]
 fwt$std.mean.fwt<-(fwt$fwt-mean.fwt)/sd.fwt
 fwt<-fwt[,-c(4:5)]
 #omits<-(fwt$SPECIES=="ADPE"&fwt$PROJECT=="CS")|(fwt$SPECIES=="CHPE"&fwt$PROJECT=="COPA")
 #fwt<-fwt[!omits,]
 names(fwt)[4]<-"index"
 fwt$param=rep("FWT",dim(fwt)[1])
 fwt$season=rep("S",dim(fwt)[1])
 # make stuff reference the correct "calendar year" for matching up with krill survey and catch data
 # summer indices are relevant to the second year in the split-season designation
 fwt$cal.yr<-as.numeric(substr(fwt$YEAR,1,4))+1
 #print(str(fwt))
 #
 # post-hatch success (phs) (numbers of chicks creched/numbers of chicks hatched)
 # bigger indicates better summer
 phs<-read.csv("success.csv",header=TRUE,stringsAsFactors = FALSE)
 phs$phs<-phs$N_CRECHE/phs$N_CHICKS
 phs$phs<-log(phs$phs/(1-phs$phs))
 phs$matchme<-paste(phs$PROJECT,phs$SPECIES,sep="|")
 tt<-tapply(phs$phs,list(phs$matchme),mean,na.rm=TRUE)
 ttt<-tapply(phs$phs,list(phs$matchme),sd,na.rm=TRUE)
 mean.phs<-tt[match(phs$matchme,names(tt))]
 sd.phs<-ttt[match(phs$matchme,names(ttt))]
 phs$std.logit.phs<-(phs$phs-mean.phs)/sd.phs
 phs<-phs[,-c(4:9)]
 names(phs)[4]<-"index"
 phs$param=rep("PHS",dim(phs)[1])
 phs$season=rep("S",dim(phs)[1])
 # summer indices are relevant to the second year in the split-season designation
 phs$cal.yr<-as.numeric(substr(phs$YEAR,1,4))+1
 #print(str(phs))
 #
 # trip duration (td)
 # smaller indicates better summer (thus need to switch direction of index)
 td<-read.csv("tripduration.csv",header=TRUE,stringsAsFactors = FALSE)
 td<-td[,c(1:3,8)]
 # next line is to make trip duration point in same direction as fwt and phs (max td is 59.95 for all trips)
 # call this "revtd" for "reversed" trip duration
 td[,4]<-60-td[,4]
 names(td)[4]<-"revtd"
 td<-tapply(td$revtd,list(td$YEAR,td$PROJECT,td$SPECIES),mean)
 td<-data.frame(YEAR=rep(dimnames(td)[[1]],dim(td)[2]*dim(td)[3]),
                PROJECT=rep(rep(dimnames(td)[[2]],each=dim(td)[1]),dim(td)[3]),
                SPECIES=rep(dimnames(td)[[3]],each=dim(td)[1]*dim(td)[2]),
                revtd=c(td),stringsAsFactors = FALSE)
 td$matchme<-paste(td$PROJECT,td$SPECIES,sep="|")
 tt<-tapply(td$revtd,list(td$matchme),mean,na.rm=TRUE)
 ttt<-tapply(td$revtd,list(td$matchme),sd,na.rm=TRUE)
 mean.revtd<-tt[match(td$matchme,names(tt))]
 sd.revtd<-ttt[match(td$matchme,names(ttt))]
 td$std.revtd<-(td$revtd-mean.revtd)/sd.revtd
 td<-td[,-c(4:5)]
 names(td)[4]<-"index"
 #omits<-(td$SPECIES=="ADPE"&td$PROJECT=="CS")|(td$SPECIES=="CHPE"&td$PROJECT=="COPA")
 #td<-td[!omits,]
 td$param=rep("REVTD",dim(td)[1])
 td$season=rep("S",dim(td)[1])
 # summer indices are relevant to the second year in the split-season designation
 td$cal.yr<-as.numeric(substr(td$YEAR,1,4))+1
 #print(str(td))
 #
 # generate the winter indices
 #
 # adult male mass at E1 lay (mml)
 # bigger indicates better winter
 ade1<-read.csv("massatlay.csv",header=TRUE,stringsAsFactors = FALSE)
 mml<-ade1[,c(1:3,5)]
 mml<-tapply(mml$WT_MALE,list(mml$YEAR,mml$PROJECT,mml$SPECIES),mean,na.rm=TRUE)
 mml<-data.frame(YEAR=rep(dimnames(mml)[[1]],dim(mml)[2]*dim(mml)[3]),
                 PROJECT=rep(rep(dimnames(mml)[[2]],each=dim(mml)[1]),dim(mml)[3]),
                 SPECIES=rep(dimnames(mml)[[3]],each=dim(mml)[1]*dim(mml)[2]),
                 mml=c(mml),stringsAsFactors = FALSE)
 mml$matchme<-paste(mml$PROJECT,mml$SPECIES,sep="|")
 tt<-tapply(mml$mml,list(mml$matchme),mean,na.rm=TRUE)
 ttt<-tapply(mml$mml,list(mml$matchme),sd,na.rm=TRUE)
 mean.mml<-tt[match(mml$matchme,names(tt))]
 sd.mml<-ttt[match(mml$matchme,names(ttt))]
 mml$std.mean.mml<-(mml$mml-mean.mml)/sd.mml
 mml<-mml[,-c(4:5)]
 names(mml)[4]<-"index"
 #omits<-(mml$SPECIES=="ADPE"&mml$PROJECT=="CS")|(mml$SPECIES=="CHPE"&mml$PROJECT=="COPA")
 #mml<-mml[!omits,]
 mml$param=rep("MML",dim(mml)[1])
 mml$season=rep("W",dim(mml)[1])
 # most winter indices (except rec) are relevant to the first year in the split-season designation
 mml$cal.yr<-as.numeric(substr(mml$YEAR,1,4))
 #print(str(mml))
 #
 #
 # adult female mass at E1 lay (fml)
 # bigger indicates better winter
 fml<-ade1[,c(1:3,6)]
 fml<-tapply(fml$WT_FEMALE,list(fml$YEAR,fml$PROJECT,fml$SPECIES),mean,na.rm=TRUE)
 fml<-data.frame(YEAR=rep(dimnames(fml)[[1]],dim(fml)[2]*dim(fml)[3]),
                 PROJECT=rep(rep(dimnames(fml)[[2]],each=dim(fml)[1]),dim(fml)[3]),
                 SPECIES=rep(dimnames(fml)[[3]],each=dim(fml)[1]*dim(fml)[2]),
                 fml=c(fml),stringsAsFactors = FALSE)
 fml$matchme<-paste(fml$PROJECT,fml$SPECIES,sep="|")
 tt<-tapply(fml$fml,list(fml$matchme),mean,na.rm=TRUE)
 ttt<-tapply(fml$fml,list(fml$matchme),sd,na.rm=TRUE)
 mean.fml<-tt[match(fml$matchme,names(tt))]
 sd.fml<-ttt[match(fml$matchme,names(ttt))]
 fml$std.mean.fml<-(fml$fml-mean.fml)/sd.fml
 fml<-fml[,-c(4:5)]
 names(fml)[4]<-"index"
 #omits<-(fml$SPECIES=="ADPE"&fml$PROJECT=="CS")|(fml$SPECIES=="CHPE"&fml$PROJECT=="COPA")
 #fml<-fml[!omits,]
 fml$param=rep("FML",dim(fml)[1])
 fml$season=rep("W",dim(fml)[1])
 # most winter indices (except rec) are relevant to the first year in the split-season designation
 fml$cal.yr<-as.numeric(substr(fml$YEAR,1,4))
 #print(str(fml))
 #
 #
 # avg egg density using both eggs (egg)
 # bigger indicates better winter
 e1e2<-read.csv("egg.csv",header=TRUE,stringsAsFactors = FALSE)
 egg<-e1e2[,c(1:3)]
 egg$egg<-(e1e2[,5]+e1e2[,7])/(e1e2[,6]+e1e2[,8])
 egg<-tapply(egg$egg,list(egg$YEAR,egg$PROJECT,egg$SPECIES),mean,na.rm=TRUE)
 egg<-data.frame(YEAR=rep(dimnames(egg)[[1]],dim(egg)[2]*dim(egg)[3]),
                 PROJECT=rep(rep(dimnames(egg)[[2]],each=dim(egg)[1]),dim(egg)[3]),
                 SPECIES=rep(dimnames(egg)[[3]],each=dim(egg)[1]*dim(egg)[2]),
                 egg=c(egg),stringsAsFactors = FALSE)
 egg$matchme<-paste(egg$PROJECT,egg$SPECIES,sep="|")
 tt<-tapply(egg$egg,list(egg$matchme),mean,na.rm=TRUE)
 ttt<-tapply(egg$egg,list(egg$matchme),sd,na.rm=TRUE)
 mean.egg<-tt[match(egg$matchme,names(tt))]
 sd.egg<-ttt[match(egg$matchme,names(ttt))]
 egg$std.mean.egg<-(egg$egg-mean.egg)/sd.egg
 egg<-egg[,-c(4:5)]
 names(egg)[4]<-"index"
 #omits<-(egg$SPECIES=="ADPE"&egg$PROJECT=="CS")|(egg$SPECIES=="CHPE"&egg$PROJECT=="COPA")
 #egg<-egg[!omits,]
 egg$param=rep("EGG",dim(egg)[1])
 egg$season=rep("W",dim(egg)[1])
 # most winter indices (except rec) are relevant to the first year in the split-season designation
 egg$cal.yr<-as.numeric(substr(egg$YEAR,1,4))
 #print(str(egg))
 #
 #
 # clutch initiation date (cid)
 # earlier indicates better winter
 cid<-read.csv("cid.csv",header=TRUE,stringsAsFactors = FALSE)[,1:4]
 # next line is to make CID point in same direction as other 
 #indices where bigger indicates better conditions (take diff from Dec 31)
 # call this "revcid" for "reversed" CID
 cid[,4]<-as.vector(as.POSIXlt(paste(substr(cid$YEAR,1,4),"-12-31",sep=""))-strptime(cid[,4],"%m/%e/%Y"))
 names(cid)[4]<-"revcid"
 cid$matchme<-paste(cid$PROJECT,cid$SPECIES,sep="|")
 tt<-tapply(cid$revcid,list(cid$matchme),mean,na.rm=TRUE)
 ttt<-tapply(cid$revcid,list(cid$matchme),sd,na.rm=TRUE)
 mean.cid<-tt[match(cid$matchme,names(tt))]
 sd.cid<-ttt[match(cid$matchme,names(ttt))]
 cid$std.revcid<-(cid$revcid-mean.cid)/sd.cid
 cid<-cid[,-c(4:5)]
 names(cid)[4]<-"index"
 cid$param=rep("REVCID",dim(cid)[1])
 cid$season=rep("W",dim(cid)[1])
 # most winter indices (except rec) are relevant to the first year in the split-season designation
 cid$cal.yr<-as.numeric(substr(cid$YEAR,1,4))
 # uncomment next line if decide to remove gentoos because of their more plastic breeding phenology
 #cid<-cid[cid$SPECIES!="GEPE",]
 #print(str(cid))
 #
 # cohort recruitment (rec)
 # bigger indicates better winter
 rec<-read.csv("recruitment.csv",header=TRUE,stringsAsFactors = FALSE)[,1:4]
 names(rec)[4]<-"rec"
 rec$rec<-log(rec$rec/(1-rec$rec))
 rec$matchme<-paste(rec$PROJECT,rec$SPECIES,sep="|")
 tt<-tapply(rec$rec,list(rec$matchme),mean,na.rm=TRUE)
 ttt<-tapply(rec$rec,list(rec$matchme),sd,na.rm=TRUE)
 mean.rec<-tt[match(rec$matchme,names(tt))]
 sd.rec<-ttt[match(rec$matchme,names(ttt))]
 rec$std.logit.rec<-(rec$rec-mean.rec)/sd.rec
 rec<-rec[,-c(4:5)]
 names(rec)[4]<-"index"
 rec$param=rep("REC",dim(rec)[1])
 rec$season=rep("W",dim(rec)[1])
 # recruitment is relevant to the second year in the split-season designation (the winter of first independence)
 rec$cal.yr<-as.numeric(substr(rec$YEAR,1,4))+1
 #print(str(rec))
 #
 # read in the krill survey and fishery data
 #
 # krill survey biomass
 survey<-read.csv("krillsurveywithJoinville.csv",header=TRUE,stringsAsFactors = FALSE)
 # use next line if want to filter acoustic data to have minimum number of miles (comment out if not desired)
 # as per CSR, 80 nmi would be about equivalent of 2 tracklines in the Bransfield
 #survey<-survey[survey$nmi.count>=80,]
 # could try changing "biomass" in following line to "mean.density.gm2" or "median.density.gm2" but haven't done that
 # change here
 survey.mod = as_tibble(survey) %>%
  group_split(gSSMU)
 # 28.7/(28.7+22) #fraction of nmi area # change here
 survey.mod[[1]]$biomass = survey.mod[[1]]$biomass * 0.566075 
 # 15.8/(15.8+16.4+36.2)fraction of nmi area # change here 
 survey.mod[[2]]$biomass = survey.mod[[2]]$biomass * 0.230994 
 # 22.0/(28.7+22.0) change here
 survey.mod[[3]]$biomass = survey.mod[[3]]$biomass * 0.433925 
 # change here
 survey.mod[[4]]$biomass = survey.mod[[4]]$biomass * 1 
 # change here
 survey = data.frame(bind_rows(survey.mod[[1]],survey.mod[[2]],survey.mod[[3]],survey.mod[[4]]))  
 
 # use next line if want to filter acoustic data to have minimum number of miles (comment out if not desired)
 # as per CSR, 80 nmi would be about equivalent of 2 tracklines in the Bransfield
 #survey<-survey[survey$nmi.count>=80,]
 # could try changing "biomass" in following line to "mean.density.gm2" or "median.density.gm2" but haven't done that
 survey<-tapply(survey$biomass,list(survey$Year,survey$gSSMU),mean,na.rm=TRUE)
 survey<-data.frame(cal.yr=rep(dimnames(survey)[[1]],dim(survey)[2]),
                    gSSMU=rep(dimnames(survey)[[2]],each=dim(survey)[1]),
                    survey=c(survey),stringsAsFactors = FALSE)
 survey$season<-ifelse(survey$cal.yr<2012,"S","W")
 # use next line if want to remove winter survey data altogether (comment out if not desired)
 #survey<-survey[survey$season=="S",]
 survey$matchme<-paste(survey$cal.yr,survey$season,survey$gSSMU,sep="|")
 #print(str(survey))
 #
 #
 # krill fishery catches
 fishery<-read.csv("c1.csv",header=TRUE,stringsAsFactors = FALSE)
 # change here - current modification for March in Winter permutation
 fishery$season<-ifelse(is.element(fishery$Month,c(10:12,1:2)),"S","W") #1:3 if March in Summer
 gSSMU1<-c("APBSE") # change here
 gSSMU2<-c("APDPW") # change here
 gSSMU3<-"APBSW" # change here
 gSSMU4<-c("APW","APE") # change here
 fishery$gSSMU<-rep(NA,dim(fishery)[1])
 fishery$gSSMU<-ifelse(is.element(fishery$AssignedSSMU,gSSMU1),1,fishery$gSSMU)
 fishery$gSSMU<-ifelse(is.element(fishery$AssignedSSMU,gSSMU2),2,fishery$gSSMU)
 fishery$gSSMU<-ifelse(is.element(fishery$AssignedSSMU,gSSMU3),3,fishery$gSSMU)
 fishery$gSSMU<-ifelse(is.element(fishery$AssignedSSMU,gSSMU4),4,fishery$gSSMU)
 fishery<-fishery[!is.na(fishery$gSSMU),]
 fishery<-tapply(fishery$TotalCatch,list(fishery$CalendarYear,fishery$gSSMU,fishery$season),sum)
 fishery<-data.frame(cal.yr=rep(dimnames(fishery)[[1]],dim(fishery)[2]*dim(fishery)[3]),
                     gSSMU=rep(rep(dimnames(fishery)[[2]],each=dim(fishery)[1]),dim(fishery)[3]),
                     season=rep(dimnames(fishery)[[3]],each=dim(fishery)[1]*dim(fishery)[2]),
                     catch=c(fishery),stringsAsFactors = FALSE)
 fishery$cal.yr<-as.numeric(as.character(fishery$cal.yr))
 fishery$gSSMU<-as.numeric(as.character(fishery$gSSMU))
 fishery$matchme<-paste(fishery$cal.yr,fishery$season,fishery$gSSMU,sep="|")
 #print(str(fishery))
 # now match predator data with krill data
 out<-rbind(fwt,phs,td,mml,fml,egg,cid,rec,make.row.names=FALSE)
 # all birds from Copa always forage in gSSMU 1 (Bransfield SSMUs)
 # CHPE from Cape Shirreff always forage in gSSMU 2 (Drake Passage SSMUs)
 # GEPE from Cape Shirreff forage in gSSMU 2 during summer and gSSMU 1 during winter
 #out$gSSMU<-ifelse(out$PROJECT=="COPA",1,
 #                  ifelse(out$SPECIES=="CHPE",2,
 #                         ifelse(out$SPECIES=="GEPE"&out$PROJECT=="CS"&out$season=="S",2,1)))
 out$gSSMU<-rep(NA,dim(out)[1])
 out$gSSMU<-ifelse(out$SPECIES=="ADPE"&out$PROJECT=="COPA"&out$season=="S",1,out$gSSMU)
 out$gSSMU<-ifelse(out$SPECIES=="ADPE"&out$PROJECT=="COPA"&out$season=="W",NA,out$gSSMU)
 out$gSSMU<-ifelse(out$SPECIES=="CHPE"&out$PROJECT=="COPA"&out$season=="S",1,out$gSSMU)
 out$gSSMU<-ifelse(out$SPECIES=="CHPE"&out$PROJECT=="COPA"&out$season=="W",NA,out$gSSMU)
 out$gSSMU<-ifelse(out$SPECIES=="GEPE"&out$PROJECT=="COPA"&out$season=="S",1,out$gSSMU)
 out$gSSMU<-ifelse(out$SPECIES=="GEPE"&out$PROJECT=="COPA"&out$season=="W",1,out$gSSMU)
 out$gSSMU<-ifelse(out$SPECIES=="CHPE"&out$PROJECT=="CS"&out$season=="S",2,out$gSSMU)
 out$gSSMU<-ifelse(out$SPECIES=="CHPE"&out$PROJECT=="CS"&out$season=="W",NA,out$gSSMU)
 out$gSSMU<-ifelse(out$SPECIES=="GEPE"&out$PROJECT=="CS"&out$season=="S",2,out$gSSMU)
 # use following line if GEPE at CS forage in gSSMU 2 during winter
 #out$gSSMU<-ifelse(out$SPECIES=="GEPE"&out$PROJECT=="CS"&out$season=="W",2,out$gSSMU)
 # use following line if GEPE at CS forage in gSSMU 1 during winter
 out$gSSMU<-ifelse(out$SPECIES=="GEPE"&out$PROJECT=="CS"&out$season=="W",3,out$gSSMU)
 #
 out$matchme<-paste(out$cal.yr,out$season,out$gSSMU,sep="|")
 out$survey<-survey$survey[match(out$matchme,survey$matchme)]
 out$catch<-fishery$catch[match(out$matchme,fishery$matchme)]
 #
 out<-out[!is.na(out$gSSMU),]
 
 # pull in the environmental indices
 #
 # SOUTHERN ANNULAR MODE
 sam<-read.csv("sam.csv")
 names(sam)<-c("yr","mo","sam")
 sam$season<-ifelse(is.element(sam$mo,c(10:12,1:3)),"S","W")
 sam$YEAR<-ifelse(is.element(sam$mo,10:12),sam$yr+1,sam$yr)
 sam<-tapply(sam$sam,list(sam$YEAR,sam$season),mean)
 sam<-data.frame(YEAR=rep(dimnames(sam)[[1]],2),season=rep(dimnames(sam)[[2]],each=dim(sam)[1]),sam=c(sam))
 out$sam<-sam$sam[match(paste(out$cal.yr,out$season,sep="|"),paste(sam$YEAR,sam$season,sep="|"))]
 out$sam.sign<-ifelse(out$sam<0,"Neg","Pos")
 #
 # OCEANIC NINO INDEX
 oni<-read.csv("oni.csv",stringsAsFactors = FALSE)
 oni$yr<-ifelse(is.element(oni$SEAS,c("OND","NDJ")),oni$YR+1,oni$YR)
 oni$season<-ifelse(is.element(oni$SEAS,c("OND","NDJ","DJF","JFM")),"S",NA)
 oni$season<-ifelse(is.element(oni$SEAS,c("AMJ","MJJ","JJA","JAS")),"W",oni$season)
 oni<-na.omit(oni)
 oni<-tapply(oni$ANOM,list(oni$yr,oni$season),mean)
 oni<-data.frame(yr=rep(dimnames(oni)[[1]],2),season=rep(dimnames(oni)[[2]],each=dim(oni)[1]),oni=c(oni))
 out$oni<-oni$oni[match(paste(out$cal.yr,out$season,sep="|"),paste(oni$yr,oni$season,sep="|"))]
 out$oni.class<-ifelse(out$oni <= -0.5, "Cool","Neutral")
 out$oni.class<-ifelse(out$oni >=0.5, "Warm",out$oni.class)
 #
 #
 # some clean up
 #
 out$catch[is.na(out$catch)]<-0
 out<-out[!is.na(out$sam),]
 out<-out[!is.nan(out$index),]
 out<-out[!is.na(out$index),]
 
 write.csv(out, file = "out.csv")  
 # will not try to impute missing winter surveys
 # but will keep winter performance indices if want to plot them
 if(!plot.winter){out<-out[!(is.na(out$survey)&out$season=="W"),]}
 #
 # if require minimum number of data points per study
 if(!is.null(trim)){
  study<-as.numeric(factor(paste(out$PROJECT,out$SPECIES,out$param,sep="|")))
  study.n<-table(study)
  keepers<-as.numeric(as.vector(dimnames(study.n[study.n>trim])[[1]]))
  out<-out[is.element(study,keepers),]
 }
 out
}
junk<-make.localhr.data()
# write out data
write.csv(junk, file = "junk.csv")  
modelstring<-"
 
      model{
    for(i in 1:nsummerobs){
      lower[i]<-max(10000,catch[i])
      summer[i]~dlnorm(mulogsummer[gssmu[i],samclass[i]],taulogsummer) T(lower[i],100000000)
    }
    
    for(i in 1:2){ # two gSSMUs #change here
      for(j in 1:2){ # two SAM classes
        mulogsummer[i,j]~dunif(0.1*meanlogsummer[i,j],10*meanlogsummer[i,j])
      }
    }
    taulogsummer<-pow(sigmalogsummer,-2)
    sigmalogsummer~dunif(0.1*sdlogsummer,10*sdlogsummer)
    for(i in 1:nsummerobs){
      hr.summer[i]<-ifelse(impute.me[i]==1,catch[i]/summer[i],1)
      bmass.summer[i]<-ifelse(impute.me[i]==1,summer[i],1)
    }
    for(i in (nsummerobs+1):nobs){
      hr.summer[i]<-0
      bmass.summer[i]<-0 
    }

    for(i in 1:nobs){
      hr[i]<-ifelse(impute.me[i]==1,hr.summer[i],catch[i]/survey[i])
      hrclass[i]<-ifelse(hr[i]<=0.01,1,ifelse(hr[i]>=0.1,3,2))
      bmass[i]<-ifelse(impute.me[i]==1,bmass.summer[i],survey[i])
      bclass[i]<-ifelse(bmass[i]<=1000000,1,2) 
    }

   
    for(i in 1:nobs){
      X[i,1]<-1.0     # intercept
      X[i,2]<-equals(bclass[i],2)-equals(bclass[i],1) # b2
      X[i,3]<-equals(hrclass[i],2)-equals(hrclass[i],1) # hr2
      X[i,4]<-equals(hrclass[i],3)-equals(hrclass[i],1) # hr3
      X[i,5]<-equals(oniclass[i],2)-equals(oniclass[i],1) # o2
      X[i,6]<-equals(oniclass[i],3)-equals(oniclass[i],1) # o3
    }
  
 
    for(i in 1:nobs){
      index[i]~dnorm(mu[i],tau.index)
      mu[i] <- inprod(X[i,],beta[])
    }
    
    beta[1]~dnorm(0, 0.0001)
    
    beta[2]~dnorm(0, 0.0001)
    
    beta[3]~dnorm(0, 0.0001)
    beta[4]~dnorm(0, 0.0001)

    beta[5]~dnorm(0, 0.0001)
    beta[6]~dnorm(0, 0.0001)
    

    # half-cauchy for variation among indices
    tau.index<-pow(sd.index,-2)
    #sd.index~dunif(0,10)
    sd.index~dt(0,t.tau.index,1)T(0,)
    t.tau.index<-pow(t.sd.index,-2)
    # hyperprior for half-cauchy scale
    t.sd.index~dunif(0,2)


    # derived quantities
    # first the design matrix for easily interpreting effects
    # row 1 -- ONI=cool, LKB<=1Mt, LHR<=0.01 (reference or best case)
    # row 2 -- ONI=cool, LKB>1Mt, 0.01<LHR<0.1
    # row 3 -- ONI=cool, LKB<=1Mt, LHR>=0.1
    # row 4 -- ONI=cool, LKB>1Mt, LHR<=0.01
    # row 5 -- ONI=cool, LKB<=1Mt, 0.01<LHR<0.1
    # row 6 -- ONI=cool, LKB>1Mt, LHR>=0.1
    # row 7 -- ONI=neutral, LKB<=1Mt, LHR<=0.01
    # row 8 -- ONI=neutral, LKB>1Mt, 0.01<LHR<0.1
    # row 9 -- ONI=neutral, LKB<=1Mt, LHR>=0.1
    # row 10 -- ONI=neutral, LKB>1Mt, LHR<=0.01
    # row 11 -- ONI=neutral, LKB<=1Mt, 0.01<LHR<0.1
    # row 12 -- ONI=neutral, LKB>1Mt, LHR>=0.1 (worst case)
    # row 13 -- ONI=warm, LKB<=1Mt, LHR<=0.01
    # row 14 -- ONI=warm, LKB>1Mt, 0.01<LHR<0.1
    # row 15 -- ONI=warm, LKB<=1Mt, LHR>=0.1
    # row 16 -- ONI=warm, LKB>1Mt, LHR<=0.01
    # row 17 -- ONI=warm, LKB<=1Mt, 0.01<LHR<0.1
    # row 18 -- ONI=warm, LKB>1Mt, LHR>=0.1
    for(i in 1:18){
      mu.new[i]<-inprod(predX[i,],beta[]) # posterior expectation at new data points
      index.new[i]~dnorm(mu.new[i],tau.index) # posterior predictive
    }
    
    # some interesting probabilities
    
    # that effects change expected performance relative to the reference case
    # high biomass
    prob[1]<-ifelse(mu.new[2]<mu.new[1],1,0)
    prob.new[1]<-ifelse(index.new[2]<index.new[1],1,0)
    # med hr
    prob[2]<-ifelse(mu.new[3]<mu.new[1],1,0)
    prob.new[2]<-ifelse(index.new[3]<index.new[1],1,0)
    # high hr
    prob[3]<-ifelse(mu.new[5]<mu.new[1],1,0)
    prob.new[3]<-ifelse(index.new[5]<index.new[1],1,0)
    # neutral ONI
    prob[4]<-ifelse(mu.new[7]<mu.new[1],1,0)
    prob.new[4]<-ifelse(index.new[7]<index.new[1],1,0)
    # warm ONI
    prob[5]<-ifelse(mu.new[13]<mu.new[1],1,0)
    prob.new[5]<-ifelse(index.new[13]<index.new[1],1,0)
    # worst case
    prob[6]<-ifelse(mu.new[12]<mu.new[1],1,0)
    prob.new[6]<-ifelse(index.new[12]<index.new[1],1,0)
    
    # that other effects are more extreme than environmental effects
    # med hr has more negative effect than neutral ONI
    prob[7]<-ifelse(mu.new[3]<mu.new[7],1,0)
    prob.new[7]<-ifelse(index.new[3]<index.new[7],1,0)
    # that high hr has more negative effect than neutral ONI
    prob[8]<-ifelse(mu.new[5]<mu.new[7],1,0)
    prob.new[8]<-ifelse(index.new[5]<index.new[7],1,0)
    # that high krill biomass has more negative effect than neutral ONI
    prob[9]<-ifelse(mu.new[2]<mu.new[7],1,0)
    prob.new[9]<-ifelse(index.new[2]<index.new[7],1,0)
    # that med hr has more negative effect than warm ONI
    prob[10]<-ifelse(mu.new[3]<mu.new[13],1,0)
    prob.new[10]<-ifelse(index.new[3]<index.new[13],1,0)
    # that high hr has more negative effect than warm ONI
    prob[11]<-ifelse(mu.new[5]<mu.new[13],1,0)
    prob.new[11]<-ifelse(index.new[5]<index.new[13],1,0)
    # that high krill biomass has more negative effect than warm ONI
    prob[12]<-ifelse(mu.new[2]<mu.new[13],1,0)
    prob.new[12]<-ifelse(index.new[2]<index.new[13],1,0)
    
    
    # that effects change expected performance relative to long-term mean
    # reference case
    prob[13]<-ifelse(mu.new[1]<0,1,0)
    prob.new[13]<-ifelse(index.new[1]<0,1,0)
    # high biomass
    prob[14]<-ifelse(mu.new[2]<0,1,0)
    prob.new[14]<-ifelse(index.new[2]<0,1,0)
    # med hr
    prob[15]<-ifelse(mu.new[3]<0,1,0)
    prob.new[15]<-ifelse(index.new[3]<0,1,0)
    # high hr
    prob[16]<-ifelse(mu.new[5]<0,1,0)
    prob.new[16]<-ifelse(index.new[5]<0,1,0)
    # neutral ONI
    prob[17]<-ifelse(mu.new[7]<0,1,0)
    prob.new[17]<-ifelse(index.new[7]<0,1,0)
    # warm ONI
    prob[18]<-ifelse(mu.new[13]<0,1,0)
    prob.new[18]<-ifelse(index.new[13]<0,1,0)
    # worst case
    prob[19]<-ifelse(mu.new[12]<0,1,0)
    prob.new[19]<-ifelse(index.new[12]<0,1,0)

  }
"
# objects needed to fit the model and monitor variables of interest
# there's a trick here -- if is.na(survey) then make survey a big number to prevent
# division by zero during imputation procedure these will either be replaced
# by imputed values (summer surveys) or not used (winter surveys)
#

pred.matrix<-matrix(c(1,-1,-1,-1,-1,-1,
                      1,1,-1,-1,-1,-1,
                      1,-1,1,0,-1,-1,
                      1,1,1,0,-1,-1,
                      1,-1,0,1,-1,-1,
                      1,1,0,1,-1,-1,
                      1,-1,-1,-1,1,0,
                      1,1,-1,-1,1,0,
                      1,-1,1,0,1,0,
                      1,1,1,0,1,0,
                      1,-1,0,1,1,0,
                      1,1,0,1,1,0,
                      1,-1,-1,-1,0,1,
                      1,1,-1,-1,0,1,
                      1,-1,1,0,0,1,
                      1,1,1,0,0,1,
                      1,-1,0,1,0,1,
                      1,1,0,1,0,1),nrow=18,ncol=6,byrow=TRUE)
hr.data<-list(index=as.vector(junk$index),
              survey=ifelse(is.na(junk$survey),1E12,junk$survey),
              catch=junk$catch,
              gssmu=junk$gSSMU,
              oniclass=as.numeric(factor(junk$oni.class)),
              samclass=as.numeric(factor(junk$sam.sign)),
              summer=junk$survey[junk$season=="S"],
              impute.me=ifelse(is.na(junk$survey)&junk$season=="S",1,0),
              meanlogsummer=tapply(log(junk$survey[junk$season=="S"]),
                                   list(junk$gSSMU[junk$season=="S"],junk$sam.sign[junk$season=="S"]),
                                   mean,na.rm=TRUE),
              sdlogsummer=sd(log(junk$survey[junk$season=="S"]),na.rm=TRUE),
              nobs=dim(junk)[1],
              nsummerobs=as.vector(table(junk$season)[1]),
              predX=pred.matrix)

#Plot the input

plot(as.vector(junk$index))
plot(ifelse(is.na(junk$survey),1E12,junk$survey))
plot(junk$catch)
plot(junk$gSSMU)
plot(as.numeric(factor(junk$oni.class)))
plot(as.numeric(factor(junk$sam.sign)))
plot(junk$survey[junk$season=="S"])
plot(ifelse(is.na(junk$survey)&junk$season=="S",1,0))
plot(tapply(log(junk$survey[junk$season=="S"]),list(junk$gSSMU[junk$season=="S"],
                                                    junk$sam.sign[junk$season=="S"]),
            mean,na.rm=TRUE))
plot(sd(log(junk$survey[junk$season=="S"]),na.rm=TRUE))
plot(dim(junk)[1])
plot(as.vector(table(junk$season)[1]))

hr.params<-c("beta","mulogsummer","sigmalogsummer","sd.index","t.sd.index")

beta.init1<-rep(-1,6)
beta.init2<-rep(0,6)
beta.init3<-rep(1,6)


hr.inits<-list(list(beta=beta.init1,t.sd.index=0.1,.RNG.seed=123,
                    .RNG.name="base::Super-Duper"),
               list(beta=beta.init2,t.sd.index=1.0,.RNG.seed=456,
                    .RNG.name="base::Super-Duper"),
               list(beta=beta.init3,t.sd.index=1.9,.RNG.seed=789,
                    .RNG.name="base::Super-Duper"))

hr.derived<-c("index.new","mu.new","prob","prob.new")

hr.imputed<-"hr"

# write out the input (to check how we are doing)
write.csv(hr.data$index, file = "index.csv")
write.csv(hr.data$survey, file = "survey.csv")
write.csv(hr.data$catch, file = "catch.csv")
write.csv(hr.data$gssmu, file = "gssmu.csv")
write.csv(hr.data$oniclass, file = "oniclass.csv")
write.csv(hr.data$samclass, file = "samclass.csv")
write.csv(hr.data$summer, file = "summer.csv")
write.csv(hr.data$impute.me, file = "imputeme.csv")

write.csv(hr.data$meanlogsummer, file = "meanlogsummer.csv")
write.csv(hr.data$sdlogsummer, file = "sdlogsummer.csv")
write.csv(hr.data$nobs, file = "nobs.csv")
write.csv(hr.data$nsummerobs, file = "nsummerobs.csv")
write.csv(hr.data$predX, file = "predX.csv")


# now do the analysis

library(coda)
library(rjags)

hr.jags<-jags.model(textConnection(modelstring),hr.data,hr.inits,n.chains=3,
                    n.adapt=250000)
# burn in for 150000 iterations
update(hr.jags, n.iter=500000)
hr.params.post<-coda.samples(hr.jags,hr.params,n.iter=125000,thin=25)
hr.derived.post<-coda.samples(hr.jags,hr.derived,n.iter=125000,thin=25)
hr.imputed.post<-coda.samples(hr.jags,hr.imputed,n.iter=125000,thin=25)
hr.params.summ<-summary(hr.params.post)
hr.derived.summ<-summary(hr.derived.post)
hr.imputed.summ<-summary(hr.imputed.post)

# write input/output
# cat(capture.output(print(hr.params.post), file="hr_params_post.txt"))
sink("hr_params.txt")
print(hr.params.post)
sink()
sink("hr_derived.txt")
print(hr.derived.summ)
sink()
sink("hr_imputed.txt")
print(hr.imputed.summ)
sink()


require(ggmcmc)
hr.params.s<-ggs(hr.params.post)
hr.derived.s<-ggs(hr.derived.post)
#load in pre-processed mcmc objects to save time
# just want to copy hr.params.s to work with it for plotting diagnostics without screwing up the original object
# also get rid of chains for t.sd.index since this is not really a parameter of interest
HR.labels<-data.frame(Parameter=dimnames(hr.params.post[[1]])[[2]],
                      Label=c("alpha","beta[3]","beta[4]","beta[5]","beta[1]",
                              "beta[2]","K[B,-]","K[D,-]","K[B,+]","K[D,+]",
                              "sigma","phi","exclude"))

hr.params2.s<-ggs(hr.params.post,par_labels = HR.labels)
hr.params2.s<-hr.params2.s[hr.params2.s$ParameterOriginal!="t.sd.index",]

ggmcmc(hr.params.s,file="diagnostics_hr_params_final.pdf")
ggmcmc(hr.derived.s,file="diagnostics_hr_derived_final.pdf")

# plot posterior expectations of marginal effects

# Figure 2

# reference (best case)
boxplot(value~I(as.numeric(Parameter)),data=hr.derived.s,subset=(as.numeric(hr.derived.s$Parameter)==19),
        range=0,ylim=c(-2,2),xaxt="n",xlim=c(0.5,7.5),ylab="expected performance",whisklty=1,boxwex=1,at=1)
# ONI
boxplot(value~I(as.numeric(Parameter)),data=hr.derived.s,subset=(is.element(as.numeric(hr.derived.s$Parameter),c(25,31))),
        range=0,xaxt="n",yaxt="n",whisklty=1,boxwex=0.5,add=TRUE,at=2:3,col="gray80")
# biomass
boxplot(value~I(as.numeric(Parameter)),data=hr.derived.s,subset=(as.numeric(hr.derived.s$Parameter)==20),
        range=0,xaxt="n",yaxt="n",whisklty=1,boxwex=1,add=TRUE,at=4,col="gray40",medcol="white")
# harvest rate
boxplot(value~I(as.numeric(Parameter)),data=hr.derived.s,subset=(is.element(as.numeric(hr.derived.s$Parameter),c(21,23))),
        range=0,yaxt="n",xaxt="n",whisklty=1,boxwex=0.5,add=TRUE,at=5:6,col="black",medcol="white")
# worst case with PARAMETER 36 chosen - so with "warm" ONI.  Should be (hr.derived.s$Parameter)==12
boxplot(value~I(as.numeric(Parameter)),data=hr.derived.s,subset=(as.numeric(hr.derived.s$Parameter)==36),
        range=0,xaxt="n",yaxt="n",whisklty=1,boxwex=1,add=TRUE,at=7)
axis(1,at=1:7,labels=c("reference","-0.5 < ONI < 0.5","ONI >= 0.5","LKB > 1 Mt","0.01 < LHR < 0.10","LHR >= 0.10","worst case"))
abline(h=mean(hr.derived.s$value[as.numeric(hr.derived.s$Parameter)==19]),lty=2)
abline(h=0)

write.csv(hr.derived.s, file = "hr_derived_s.csv")  
# #  Added by me - plot all cases*
# # reference (best case)
boxplot(value~I(as.numeric(Parameter)),data=hr.derived.s,subset=(as.numeric(hr.derived.s$Parameter)==19),
        range=0,ylim=c(-2,2),xaxt="n",xlim=c(0.5,18.5),ylab="expected performance",whisklty=1,boxwex=1,at=1)

boxplot(value~I(as.numeric(Parameter)),data=hr.derived.s,subset=(is.element(as.numeric(hr.derived.s$Parameter),c(20:36))),
        range=0,xaxt="n",yaxt="n",whisklty=1,boxwex=0.5,add=TRUE,at=2:18,col="gray80")

axis(1,at=1:18,labels=c("1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18"))
abline(h=mean(hr.derived.s$value[as.numeric(hr.derived.s$Parameter)==19]),lty=2)
abline(h=0)

# Supplementary Figures

# S1 -- trace plots of main model parameters
ggs_traceplot(hr.params2.s) + facet_wrap(~ Parameter, ncol = 3, scales="free")

# S2 -- scale-reduction factors
ggs_Rhat(hr.params2.s)

# S3 -- Geweke Z-scores
ggs_geweke(hr.params2.s,shadow_limit = 1.96)

# S4 -- autocorrelation plots
ggs_autocorrelation(hr.params2.s)

# S5 -- crosscorrelations
ggs_crosscorrelation(hr.params2.s)
#hr.params2.s<-ggs(hr.params.post)
#hr.params2.s<-hr.params2.s[hr.params2.s$Parameter!="t.sd.index",]
#ggs_pairs(hr.params2.s,lower=list(continuous="density"))

# S6 -- posterior distributions
ggs_histogram(hr.params2.s) + facet_wrap(~ Parameter, ncol = 3, scales="free")
#ggs_density(hr.params2.s) + facet_wrap(~ Parameter, ncol = 3, scales="free")

# S7 -- plot posterior predictive distributions over data for visual posterior predictive check
xx<-junk
xx$impute.me<-ifelse(is.na(xx$survey) & xx$season=="S",1,0)
xx$imputed.hr<-hr.imputed.summ$statistics[,1]
xx$survey[xx$impute.me==1]<-xx$catch[xx$impute.me==1]/xx$imputed.hr[xx$impute.me==1]
xx$hr.class<-ifelse(xx$catch/xx$survey<=0.01,1,ifelse(xx$catch/xx$survey>=0.1,3,2))
xx$kb.class<-ifelse(xx$survey<=1000000,1,2) 
xx$oni.class<-as.numeric(factor(xx$oni.class))
xx$case<-ifelse(xx$oni.class==1 & xx$kb.class==1 & xx$hr.class==1,1,
                ifelse(xx$oni.class==1 & xx$kb.class==2 & xx$hr.class==1,2,
                       ifelse(xx$oni.class==1 & xx$kb.class==1 & xx$hr.class==2,3,
                              ifelse(xx$oni.class==1 & xx$kb.class==2 & xx$hr.class==2,4,
                                     ifelse(xx$oni.class==1 & xx$kb.class==1 & xx$hr.class==3,5,
                                            ifelse(xx$oni.class==1 & xx$kb.class==2 & xx$hr.class==3,6,
                                                   ifelse(xx$oni.class==2 & xx$kb.class==1 & xx$hr.class==1,7,
                                                          ifelse(xx$oni.class==2 & xx$kb.class==2 & xx$hr.class==1,8,
                                                                 ifelse(xx$oni.class==2 & xx$kb.class==1 & xx$hr.class==2,9,
                                                                        ifelse(xx$oni.class==2 & xx$kb.class==2 & xx$hr.class==2,10,
                                                                               ifelse(xx$oni.class==2 & xx$kb.class==1 & xx$hr.class==3,11,
                                                                                      ifelse(xx$oni.class==2 & xx$kb.class==2 & xx$hr.class==3,12,
                                                                                             ifelse(xx$oni.class==3 & xx$kb.class==1 & xx$hr.class==1,13,
                                                                                                    ifelse(xx$oni.class==3 & xx$kb.class==2 & xx$hr.class==1,14,
                                                                                                           ifelse(xx$oni.class==3 & xx$kb.class==1 & xx$hr.class==2,15,
                                                                                                                  ifelse(xx$oni.class==3 & xx$kb.class==2 & xx$hr.class==2,16,
                                                                                                                         ifelse(xx$oni.class==3 & xx$kb.class==1 & xx$hr.class==3,17,18)))))))))))))))))
# plot the data
plot(jitter(xx$case[xx$impute.me==0],amount=0.25),xx$index[xx$impute.me==0],type="n",xlim=c(0.65,18.35),
     ylim=c(-3.5,3.5),
     xlab="case",xaxt="n",ylab="std performance index",pch=16)
# add posterior predictive distributions as box plots
for(i in 1:18){
 boxplot(value~I(as.numeric(Parameter)),data=hr.derived.s,subset=(as.numeric(hr.derived.s$Parameter)==i),
         range=1.5,outline=FALSE,xaxt="n",whisklty=1,boxwex=1,at=i,add=TRUE)
}
# plot the data
points(jitter(xx$case[xx$impute.me==0&xx$season=="S"],amount=0.2),xx$index[xx$impute.me==0&xx$season=="S"],
       cex=0.5,col="red",pch=16)
points(jitter(xx$case[xx$impute.me==0&xx$season=="W"],amount=0.2),xx$index[xx$impute.me==0&xx$season=="W"],
       cex=0.5,col="blue",pch=16)
points(jitter(xx$case[xx$impute.me==1],amount=0.2),xx$index[xx$impute.me==1],cex=0.5,col="red")
axis(1,at=1:18)
abline(h=0)

# misc stuff

junk2<-make.localhr.data(plot.winter=TRUE)
junk2$impute.me<-ifelse(is.na(junk2$survey)&junk2$season=="S",1,0)
junk2$imputed<-exp(ifelse(junk2$impute.me==0,NA,ifelse(junk2$gSSMU==1&junk2$sam.sign=="Neg",
                                                       hr.params.summ$statistics[7,1],
                                                       ifelse(junk2$gSSMU==2&junk2$sam.sign=="Neg",hr.params.summ$statistics[8,1],
                                                              ifelse(junk2$gSSMU==1&junk2$sam.sign=="Pos",hr.params.summ$statistics[9,1],
                                                                     hr.params.summ$statistics[10,1])))))

library(lattice)
# plot the time series
xyplot(index~cal.yr|season,data=junk2,horizontal=FALSE,aspect=0.25,panel=function(x,y,subscripts,...,Z=junk2$survey,IMP=junk2$imputed){
 z<-(Z[subscripts]-mean(c(Z[subscripts],IMP[subscripts]),na.rm=TRUE))/sd(c(Z[subscripts],IMP[subscripts]),na.rm=TRUE)
 imp<-(IMP[subscripts]-mean(c(Z[subscripts],IMP[subscripts]),na.rm=TRUE))/sd(c(Z[subscripts],IMP[subscripts]),na.rm=TRUE)
 panel.xyplot(x,y,...,pch=16,col="black")
 panel.points(as.numeric(x),z,col="red",pch=16,cex=1.25)
 panel.points(as.numeric(x),imp,col="red",pch=1,cex=1.25)
 panel.abline(h=0,lty=2)},
 ylim=c(-3.5,4.5),layout=c(1,2),xlab="year",ylab="std monitoring index")

# plot the time series with env indices (panel for Fig 1)
xyplot(index~cal.yr|season+PROJECT,data=junk2,horizontal=FALSE,aspect=0.5,panel=function(x,y,subscripts,...,Z=junk2$survey,
                                                                                         IMP=junk2$imputed,ONI=junk2$oni,SAM=junk2$sam){
 z<-(Z[subscripts]-mean(c(Z[subscripts],IMP[subscripts]),na.rm=TRUE))/sd(c(Z[subscripts],IMP[subscripts]),na.rm=TRUE)
 imp<-(IMP[subscripts]-mean(c(Z[subscripts],IMP[subscripts]),na.rm=TRUE))/sd(c(Z[subscripts],IMP[subscripts]),na.rm=TRUE)
 panel.xyplot(x,y,...,pch=16,col="black")
 panel.points(as.numeric(x),z,col="red",pch=16,cex=1.25)
 panel.points(as.numeric(x),imp,col="red",pch=1,cex=1.25)
 tt.oni<-data.frame(as.numeric(x),ONI[subscripts])
 tt.oni<-tt.oni[order(tt.oni[,1]),]
 panel.lines(tt.oni[,1],tt.oni[,2],col="blue")
 tt.sam<-data.frame(as.numeric(x),SAM[subscripts])
 tt.sam<-tt.sam[order(tt.sam[,1]),]
 panel.lines(tt.sam[,1],tt.sam[,2],col="dark green")
 panel.abline(h=0,lty=2)},
 ylim=c(-3.5,4.5),layout=c(2,2),xlab="year",ylab="index")


# some stuff to tablulate local harvest rates by year (including imputed estimates)

junk$impute.me<-ifelse(is.na(junk$survey)&junk$season=="S",1,0)
junk$survey<-ifelse(junk$impute.me==0,junk$survey,exp(ifelse(junk$gSSMU==1&junk$sam.sign=="Neg",
                                                             hr.params.summ$statistics[7,1],
                                                             ifelse(junk$gSSMU==2&junk$sam.sign=="Neg",hr.params.summ$statistics[8,1],
                                                                    ifelse(junk$gSSMU==1&junk$sam.sign=="Pos",hr.params.summ$statistics[9,1],
                                                                           hr.params.summ$statistics[10,1])))))
junk$hr<-junk$catch/junk$survey
junk$hihr<-(junk$hr>=0.10)

# table for supplementary info
jj<-unique(junk[,c(7,8,6,11,17,16)])
names(jj)<-c("calendar.year","stratum","season","catch","LHR","imputed")
jj$stratum<-ifelse(jj$stratum==1,"Bransfield","Drake")
jj$season<-ifelse(jj$season=="S","Summer","Winter")
jj$imputed<-ifelse(jj$imputed==1,"Yes","No")
# no catch data for 2016
jj<-jj[jj$calendar.year!=2016,]
write.csv(jj[order(jj[,1],jj[,2],jj[,3]),],file="hr.csv",row.names = FALSE)

# variation in catch by season and decade (panel for Fig 3)
tt<-read.csv("c1.csv",header=TRUE,stringsAsFactors = FALSE)
tt<-tt[is.element(tt$AssignedSSMU,c("APBSE","APBSW","APDPE","APDPW","APE","APEI","APPA","APW")),]
tt$FishingSeason<-ifelse(tt$Month==12,tt$CalendarYear+1,tt$CalendarYear)
tt$season<-ifelse(is.element(tt$Month,c(10:12,1:3)),"S","W")
tt$decade<-ifelse(tt$FishingSeason<1990,"before 1990",
                  ifelse(tt$FishingSeason>1989&tt$FishingSeason<2000,"1990-1999",
                         ifelse(tt$FishingSeason>1999&tt$FishingSeason<2010,"2000-2009","after 2009")))
tt$decade<-ordered(tt$decade,levels=c("before 1990","1990-1999","2000-2009","after 2009"))
tt<-tapply(tt$TotalCatch,list(tt$decade,tt$season),sum)
tt<-data.frame(catch=as.numeric(tt),decade=rep(dimnames(tt)[[1]],dim(tt)[2]),season=rep(dimnames(tt)[[2]],
                                                                                        each=dim(tt)[1]))
tt$decade<-ordered(tt$decade,levels=c("before 1990","1990-1999","2000-2009","after 2009"))
#
barchart(I(catch/1000)~season|decade,data=tt,layout=c(4,1),aspect=1,xlab="Season",ylab="Total catch (1000 t)")
```

# Citations
